/*
 * ATTENTION: The "eval" devtool has been used (maybe by default in mode: "development").
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
/******/ (() => { // webpackBootstrap
/******/ 	var __webpack_modules__ = ({

/***/ "./src/index.js":
/*!**********************!*\
  !*** ./src/index.js ***!
  \**********************/
/***/ (() => {

eval("const FONT_SOURCES = {\r\n  'inter, sans-serif':\r\n    'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap',\r\n  'roboto, sans-serif':\r\n    'https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap',\r\n  'open sans, sans-serif':\r\n    'https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap',\r\n  'poppins, sans-serif':\r\n    'https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap',\r\n  'montserrat, sans-serif':\r\n    'https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&display=swap',\r\n  'lato, sans-serif':\r\n    'https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap',\r\n  'nunito, sans-serif':\r\n    'https://fonts.googleapis.com/css2?family=Nunito:wght@400;600&display=swap',\r\n  'source sans 3, sans-serif':\r\n    'https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;600&display=swap',\r\n  'playfair display, serif':\r\n    'https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&display=swap',\r\n  'manrope, sans-serif':\r\n    'https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap',\r\n  'raleway, sans-serif':\r\n    'https://fonts.googleapis.com/css2?family=Raleway:wght@400;500;600&display=swap',\r\n  'dm sans, sans-serif':\r\n    'https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap',\r\n  'work sans, sans-serif':\r\n    'https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600&display=swap',\r\n  'karla, sans-serif':\r\n    'https://fonts.googleapis.com/css2?family=Karla:wght@400;600&display=swap',\r\n  'nunito sans, sans-serif':\r\n    'https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600&display=swap',\r\n  'pt sans, sans-serif':\r\n    'https://fonts.googleapis.com/css2?family=PT+Sans:wght@400;700&display=swap',\r\n  'oswald, sans-serif':\r\n    'https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600&display=swap',\r\n  'space grotesk, sans-serif':\r\n    'https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&display=swap',\r\n  'merriweather, serif':\r\n    'https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap',\r\n  'libre baskerville, serif':\r\n    'https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&display=swap',\r\n};\r\n\r\nfunction normalizeFontKey(fontFamily = '') {\r\n  return fontFamily\r\n    .toLowerCase()\r\n    .replace(/[\"']/g, '')\r\n    .replace(/\\s*,\\s*/g, ', ')\r\n    .replace(/\\s+/g, ' ')\r\n    .trim();\r\n}\r\n\r\nfunction ensureFontLoaded(fontFamily) {\r\n  if (!fontFamily) return;\r\n  const key = normalizeFontKey(fontFamily);\r\n  const href = FONT_SOURCES[key];\r\n  if (!href) return;\r\n  if (document.querySelector(`link[data-ultimo-font=\"${key}\"]`)) return;\r\n  const link = document.createElement('link');\r\n  link.rel = 'stylesheet';\r\n  link.href = href;\r\n  link.setAttribute('data-ultimo-font', key);\r\n  document.head.appendChild(link);\r\n}\r\n\r\n(function bootstrap() {\r\n  const POLL_INTERVAL = 200;\r\n  const MAX_WAIT = 60000;\r\n  let waited = 0;\r\n\r\n  let started = false;\r\n\r\n  function startIfReady() {\r\n    if (started) return true;\r\n    const container = document.getElementById('chat-widget-container');\r\n    if (container && container.getAttribute('data-user-id')) {\r\n      started = true;\r\n      initializeChatWidget();\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  const observer = new MutationObserver(() => {\r\n    if (startIfReady()) observer.disconnect();\r\n  });\r\n  observer.observe(document.body, { childList: true, subtree: true });\r\n\r\n  function tryStart() {\r\n    if (startIfReady()) return;\r\n    if (waited < MAX_WAIT) {\r\n      waited += POLL_INTERVAL;\r\n      setTimeout(tryStart, POLL_INTERVAL);\r\n    } else {\r\n      console.error(`Chat widget bootstrap: container not found after ${MAX_WAIT / 1000}s`);\r\n      observer.disconnect();\r\n    }\r\n  }\r\n\r\n  if (document.readyState === 'loading') {\r\n    document.addEventListener('DOMContentLoaded', tryStart);\r\n  } else {\r\n    tryStart();\r\n  }\r\n})();\r\n\r\nfunction addUltimoBacklink(promotingText, removePoweredBy) {\r\n  if (\r\n    removePoweredBy ||\r\n    document.querySelector('a[href=\"https://www.ultimo-bots.com\"]')\r\n  ) {\r\n    return;\r\n  }\r\n\r\n  const backlink = document.createElement('a');\r\n  backlink.href = 'https://www.ultimo-bots.com';\r\n  backlink.target = '_blank';\r\n  backlink.rel = 'noopener noreferrer';\r\n  backlink.textContent = promotingText;\r\n  backlink.style.display = 'block';\r\n  backlink.style.textAlign = 'center';\r\n  backlink.style.fontSize = '4px';\r\n  backlink.style.opacity = '0.9';\r\n  backlink.style.textDecoration = 'none';\r\n  backlink.style.color = '#555555';\r\n  backlink.style.margin = '0';\r\n  backlink.style.padding = '0';\r\n  backlink.style.paddingTop = '2px';\r\n  backlink.style.paddingBottom = '2px';\r\n\r\n  document.body.appendChild(backlink);\r\n}\r\n\r\nasync function initializeChatWidget() {\r\n  ['https://portal.ultimo-bots.com', 'https://cdn.jsdelivr.net']\r\n    .forEach(h => {\r\n      if (!document.querySelector(`link[rel=\"preconnect\"][href=\"${h}\"]`)) {\r\n        const l = document.createElement('link');\r\n        l.rel = 'preconnect'; l.href = h; l.crossOrigin = ''; document.head.appendChild(l);\r\n      }\r\n    });\r\n  let markedReady = typeof marked !== 'undefined';\r\n\r\n  async function ensureMarked() {\r\n    if (markedReady) return;\r\n\r\n    const mod = await import(/* webpackIgnore: true */\r\n      'https://cdn.jsdelivr.net/npm/marked@11.1.1/lib/marked.esm.js');\r\n\r\n    mod.marked.setOptions({ gfm: true, breaks: true, headerIds: false });\r\n    globalThis.marked = mod.marked;\r\n    markedReady = true;\r\n  }\r\n\r\n  const container = document.getElementById('chat-widget-container');\r\n  if (!container) { console.error('Chat widget container not found'); return; }\r\n\r\n  if (container.parentElement !== document.body) document.body.appendChild(container);\r\n\r\n  Object.assign(container.style, {\r\n    position: 'fixed',\r\n    top: '0',\r\n    left: '0',\r\n    width: '0',\r\n    height: '0',\r\n    zIndex: '2147483647',\r\n    pointerEvents: 'none',\r\n  });\r\n\r\n  const botId = container.getAttribute('data-user-id');\r\n  if (!botId) { console.error('User ID not found (data-user-id is missing)'); return; }\r\n\r\n  const POPUP_KEY = `saicf-popup-seen-${botId}`;\r\n  let   popUpSeen = sessionStorage.getItem(POPUP_KEY) === '1';\r\n\r\n  function markPopUpSeen() {\r\n    if (!popUpSeen) {\r\n      popUpSeen = true;\r\n      sessionStorage.setItem(POPUP_KEY, '1');\r\n    }\r\n  }\r\n\r\n  if (!container.isConnected) {\r\n    document.body.appendChild(container);\r\n  }\r\n  const shadowRoot = container.shadowRoot || container.attachShadow({ mode: 'open' });\r\n\r\n  shadowRoot.host.setAttribute('lang', 'en');\r\n\r\n  if (!document.getElementById('saicf-global-scroll-style')) {\r\n    const globalScrollStyle = document.createElement('style');\r\n    globalScrollStyle.id = 'saicf-global-scroll-style';\r\n    globalScrollStyle.textContent = `\r\n      body.no-scroll,\r\n      html.no-scroll {\r\n        overflow: hidden !important;\r\n        position: fixed !important;\r\n        inset: 0 !important;\r\n        width: 100% !important;\r\n        touch-action: none !important;\r\n        overscroll-behavior: none !important;\r\n      }\r\n    `;\r\n    document.head.appendChild(globalScrollStyle);\r\n  }\r\n\r\n  const styleTag = document.createElement('style');\r\n  styleTag.textContent = `\r\n    /**********************************************************\r\n     * Embedded widget.css (now isolated to this Shadow DOM)\r\n     **********************************************************/\r\n\r\n    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ FULL ISOLATION: kill any inherited styles â”€â”€â”€â”€â”€â”€â”€â”€â”€ */\r\n    :host {\r\n      all: initial;\r\n      box-sizing: border-box;\r\n      font-family: var(--saicf-font-family, \"DM Sans\", sans-serif);\r\n      z-index: 2147483647 !important;\r\n      position: fixed !important;   /* ðŸ‘ˆ add this */\r\n      top: 0; left: 0; width: 0; height: 0;\r\n      pointer-events: none;\r\n    }\r\n\r\n    .saicf-chat-window,\r\n    .saicf-chat-widget-icon,\r\n    .saicf-pop-up-container { pointer-events: auto; }\r\n\r\n    /* keep borderâ€‘box for everything inside */\r\n    :host *, :host *::before, :host *::after {\r\n      box-sizing: inherit;\r\n    }\r\n\r\n    :host, .saicf-chat-window, .saicf-chat-window * {\r\n      font-family: var(--saicf-font-family, \"DM Sans\", sans-serif) !important;\r\n    }\r\n\r\n    :host {\r\n      --widget-size: 80px; /* fallback â€“ will be overwritten by JS */\r\n    }\r\n\r\n    .saicf-chat-window p {\r\n      line-height: 1.3 !important;\r\n      font-size: 15px !important;\r\n    }\r\n    .saicf-chat-widget-icon {\r\n      position: fixed;\r\n      bottom: 20px;\r\n      right: 20px;\r\n      color: white;\r\n      border-radius: 50%;\r\n      width: 100px;\r\n      height: 100px;\r\n      display: flex;\r\n      justify-content: center;\r\n      align-items: center;\r\n      cursor: pointer;\r\n      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);\r\n      font-size: 36px;\r\n      z-index: 999998 !important;\r\n    }\r\n    @keyframes pulse {\r\n      0% { transform: scale(1); }\r\n      50% { transform: scale(1.1); }\r\n      100% { transform: scale(1); }\r\n    }\r\n    .pulsing {\r\n      animation: pulse 2s infinite;\r\n    }\r\n    .saicf-chat-title {\r\n      font-size: 15px;\r\n      font-weight: 700;\r\n    }\r\n    .saicf-chat-window {\r\n      position: fixed;\r\n      bottom: 12px;\r\n      right: 12px;\r\n      width: 430px;\r\n      height: 620px;\r\n      background-color: transparent;\r\n      border: none;\r\n      border-radius: 16px;\r\n      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);\r\n      display: flex !important;\r\n      flex-direction: column;\r\n      z-index: 2147483647 !important;\r\n      opacity: 0;\r\n      transform: translateY(100%);\r\n      transition: opacity 0.5s ease, transform 0.5s ease;\r\n    }\r\n    .saicf-chat-window.show {\r\n      opacity: 1;\r\n      transform: translateY(0);\r\n    }\r\n    .hidden {\r\n      display: none !important;\r\n    }\r\n    .saicf-chat-header {\r\n      color: white;\r\n      padding: 10px 15px;\r\n      border-radius: 16px 16px 0px 0px;\r\n      display: flex;\r\n      flex-direction: column;\r\n    }\r\n    .saicf-chat-header-title {\r\n      display: flex;\r\n      justify-content: space-between;\r\n      align-items: center;\r\n    }\r\n    .saicf-logo-message-container {\r\n      display: flex;\r\n      align-items: center;\r\n      gap: 8px;\r\n    }\r\n    .saicf-close-btn {\r\n      background: none;\r\n      border: none;\r\n      color: rgb(218, 43, 43);\r\n      margin: 0;\r\n      padding: 0;\r\n      outline: none;\r\n      cursor: pointer;\r\n    }\r\n    .saicf-close-chat-widget-icon {\r\n      cursor: pointer;\r\n      transition: opacity 0.4s ease, transform 0.4s ease;\r\n    }\r\n    .saicf-close-chat-widget-icon .fa-xmark,\r\n    .saicf-close-chat-widget-icon svg {\r\n      font-size: 1.6rem;   /* or whatever looks right */\r\n    }\r\n    .saicf-close-chat-widget-icon:hover {\r\n      transform: scale(1.2);\r\n    }\r\n    .saicf-chat-body-wrapper {\r\n      position: relative;\r\n      flex: 1 1 auto;\r\n      min-height: 0;\r\n      display: flex;\r\n      flex-direction: column;\r\n    }\r\n    .saicf-chat-body {\r\n      flex: 1;\r\n      padding: 8px;\r\n      padding-top: 0;\r\n      overflow-y: auto;\r\n      display: flex;\r\n      flex-direction: column;\r\n      background-color: white;\r\n      position: relative;\r\n    }\r\n    .saicf-scroll-to-bottom-btn {\r\n      position: absolute;\r\n      bottom: 8px;\r\n      left: 50%;\r\n      transform: translateX(-50%);\r\n      width: 32px;\r\n      height: 32px;\r\n      border-radius: 50%;\r\n      border: 1px solid #e0e0e0;\r\n      background: #fff;\r\n      color: #555;\r\n      cursor: pointer;\r\n      display: flex;\r\n      align-items: center;\r\n      justify-content: center;\r\n      box-shadow: 0 2px 6px rgba(0,0,0,0.15);\r\n      z-index: 10;\r\n      opacity: 0;\r\n      pointer-events: none;\r\n      transition: opacity 0.25s ease, background-color 0.2s;\r\n      padding: 0;\r\n      margin: 0;\r\n      outline: none;\r\n    }\r\n    .saicf-scroll-to-bottom-btn.visible {\r\n      opacity: 1;\r\n      pointer-events: auto;\r\n    }\r\n    .saicf-scroll-to-bottom-btn:hover {\r\n      background-color: #f5f5f5;\r\n    }\r\n    .saicf-chat-footer {\r\n      display: flex;\r\n      flex-direction: column;\r\n      // padding: 10px;\r\n      background-color: white;\r\n      gap: 8px;\r\n    }\r\n    .saicf-powered-by {\r\n      display: flex;\r\n      justify-content: center;\r\n    }\r\n    .saicf-powered-by-text {\r\n      font-size: 10px;\r\n      color: rgb(146, 146, 146);\r\n      cursor: pointer;\r\n      text-decoration: underline;\r\n    }\r\n    .saicf-input-send-container {\r\n      display: flex;\r\n      border-top: 1px solid #f1f1f1;\r\n      padding: 10px;\r\n      background-color: #fafafa;\r\n      align-items: flex-end;\r\n    }\r\n    .saicf-chat-footer textarea {\r\n      flex: 1 !important;\r\n      padding: 10px !important;\r\n      border: 1px solid #ccc !important;\r\n      border-radius: 8px !important;\r\n      outline: none !important;\r\n      font-size: 16px !important;\r\n      font-family: inherit !important;\r\n      resize: none !important;\r\n      line-height: 24px !important;\r\n      max-height: 140px !important;\r\n      overflow-y: hidden !important;\r\n      box-sizing: border-box !important;\r\n    }\r\n    .saicf-chat-footer textarea.has-overflow {\r\n      overflow-y: auto !important;\r\n    }\r\n    .saicf-chat-footer button {\r\n      display: flex;\r\n      align-items: center;\r\n      margin-left: 6px;\r\n      padding-left: 15px;\r\n      padding-right: 15px;\r\n      color: white;\r\n      border: none;\r\n      border-radius: 10px;\r\n      cursor: pointer;\r\n      transition: background-color 0.4s ease, transform 0.2s ease;\r\n      height: 44px;\r\n      min-height: 44px;\r\n      align-self: flex-end;\r\n    }\r\n    .saicf-chat-footer button:hover {\r\n      background-color: #0595d3;\r\n      transform: translateY(-1.5px);\r\n    }\r\n    .saicf-message-row {\r\n      display: flex;\r\n      align-items: flex-start;\r\n      gap: 0px;\r\n      margin: 6px 0;\r\n    }\r\n    .saicf-message-row.user {\r\n      justify-content: flex-end;\r\n    }\r\n    .saicf-message-row.user .saicf-widget-message {\r\n      margin-left: auto;\r\n    }\r\n    .saicf-message-avatar {\r\n      width: 24px;\r\n      height: 24px;\r\n      border-radius: 50%;\r\n      background-size: cover;\r\n      background-position: center;\r\n      background-color: rgba(0,0,0,0.05);\r\n      border: 1px solid rgba(0,0,0,0.08);\r\n      flex-shrink: 0;\r\n      margin-top: 7px;\r\n    }\r\n\r\n    .saicf-widget-message {\r\n      max-width: 80%;\r\n      margin: 5px 0;\r\n      padding: 5px;\r\n      border-radius: 10px;\r\n      display: inline-block;\r\n    }\r\n    .saicf-message-row.bot .saicf-widget-message {\r\n      max-width: calc(100% - 48px);\r\n    }\r\n    .widget-user-message {\r\n      align-self: flex-end !important;\r\n      color: white !important;\r\n      border-radius: 8px !important;\r\n      padding: 8px !important;\r\n      font-size: 15px !important;\r\n    }\r\n    .widget-bot-message {\r\n      align-self: flex-start !important;\r\n      background-color: #ffffff !important;\r\n      color: rgb(43, 43, 43) !important;\r\n      border-radius: 8px;\r\n      font-size: 15px !important;\r\n    }\r\n    /* Headings inside bot bubbles: same size as paragraph */\r\n    .widget-bot-message h1,\r\n    .widget-bot-message h2,\r\n    .widget-bot-message h3,\r\n    .widget-bot-message h4,\r\n    .widget-bot-message h5,\r\n    .widget-bot-message h6 {\r\n      font-size: 1em !important;\r\n      line-height: inherit !important;\r\n      margin: 0 0 .9em !important;\r\n    }\r\n    .widget-bot-message strong {\r\n      color: rgb(57, 57, 57);\r\n    }\r\n    .widget-bot-message ul li:not(:last-child) {\r\n      margin-bottom: 6px;\r\n    }\r\n    .widget-user-message > :first-child,\r\n    .widget-bot-message > :first-child {\r\n      margin-top: 0;\r\n    }\r\n    .widget-user-message > :last-child,\r\n    .widget-bot-message > :last-child {\r\n      margin-bottom: 0;\r\n    }\r\n    /* Headings inside user bubbles: same size as paragraph */\r\n    .widget-user-message h1,\r\n    .widget-user-message h2,\r\n    .widget-user-message h3,\r\n    .widget-user-message h4,\r\n    .widget-user-message h5,\r\n    .widget-user-message h6 {\r\n      font-size: 1em !important;\r\n      line-height: inherit !important;\r\n      margin: 0 0 .9em !important;\r\n    }\r\n    .saicf-widget-send-icon {\r\n      font-size: 18px;\r\n      font-style: normal;\r\n    }\r\n    .saicf-loading-row {\r\n      display: flex;\r\n      justify-content: flex-start;\r\n      margin: 6px 0;\r\n    }\r\n    .saicf-loading-dots {\r\n      display: flex;\r\n      justify-content: left;\r\n      align-items: center;\r\n      height: 40px;\r\n      margin-top: 10px;\r\n      margin-bottom: 5px;\r\n    }\r\n    .saicf-loading-dots div {\r\n      width: 8px;\r\n      height: 8px;\r\n      margin: 0 4px;\r\n      border-radius: 50%;\r\n      animation: loading 0.6s infinite alternate;\r\n    }\r\n    @keyframes loading {\r\n      to {\r\n        opacity: 0.3;\r\n        transform: translateY(-8px);\r\n      }\r\n    }\r\n    .saicf-loading-dots div:nth-child(2) {\r\n      animation-delay: 0.2s;\r\n    }\r\n    .saicf-loading-dots div:nth-child(3) {\r\n      animation-delay: 0.4s;\r\n    }\r\n    .saicf-chat-widget-icon.align-left {\r\n      left: 25px !important;\r\n      right: auto !important;\r\n    }\r\n    .saicf-chat-widget-icon.elevated {\r\n      bottom: 70px !important;\r\n    }\r\n    .saicf-chat-window.align-left {\r\n      left: 20px !important;\r\n      right: auto !important;\r\n    }\r\n    .saicf-chat-window.elevated {\r\n      bottom: 12px !important;\r\n    }\r\n    .saicf-widget-message table {\r\n      border-collapse: separate;\r\n      border-spacing: 0px;\r\n      margin-top: 15px;\r\n      margin-bottom: 15px;\r\n      width: 100%;\r\n      overflow: auto;\r\n    }\r\n    .saicf-widget-message th, .saicf-widget-message td {\r\n      border: 1px solid rgba(0, 0, 0, 0.08);\r\n      padding: .35rem .50rem;\r\n      text-align: left;\r\n      font-size: 14px;\r\n    }\r\n    .saicf-widget-message th {\r\n      color: #000000;\r\n      background-color: rgba(0, 0, 0, 0.06);\r\n      border-right: 0;\r\n      padding: .5rem .50rem;\r\n      border-bottom: none;\r\n    }\r\n    .saicf-widget-message th:last-child {\r\n      border-right: 1px solid rgba(0, 0, 0, 0.08);\r\n    }\r\n    .saicf-widget-message td {\r\n      border-bottom: 0px solid rgba(0, 0, 0, 0.08);\r\n      border-right: 0px solid rgba(0, 0, 0, 0.08);\r\n    }\r\n    .saicf-widget-message td:last-child {\r\n      border-right: 1px solid rgba(0, 0, 0, 0.08);\r\n    }\r\n    .saicf-widget-message tr:first-child th:first-child {\r\n      border-top-left-radius: 8px;\r\n    }\r\n    .saicf-widget-message tr:first-child th:last-child {\r\n      border-top-right-radius: 8px;\r\n    }\r\n    .saicf-widget-message tr:last-child td:first-child {\r\n      border-bottom-left-radius: 8px;\r\n    }\r\n    .saicf-widget-message tr:last-child td:last-child {\r\n      border-bottom-right-radius: 8px;\r\n    }\r\n    .saicf-widget-message tr:last-child td {\r\n      border-bottom: 1px solid rgba(0, 0, 0, 0.08);\r\n    }\r\n\r\n    /**********************************************************\r\n     * Pop-up message styles\r\n     **********************************************************/\r\n    .saicf-pop-up-container {\r\n      position: fixed;\r\n      right: 20px;\r\n      bottom: calc(30px + var(--widget-size));\r\n      display: flex;\r\n      flex-direction: column;\r\n      gap: 8px;\r\n      z-index: 999999;\r\n    }\r\n    .saicf-pop-up-container.hidden {\r\n      pointer-events: none;\r\n    }\r\n    .saicf-pop-up-container.align-left {\r\n      left: 25px !important;\r\n      right: auto !important;\r\n    }\r\n\r\n    .saicf-pop-up-container.elevated {\r\n      bottom: calc(80px + var(--widget-size));   /* 55 px (icon) + 10 px gap */\r\n    }\r\n\r\n    .saicf-pop-up-message {\r\n      background:rgb(250, 250, 250);\r\n      padding: 8px 12px;\r\n      border-radius: 12px;\r\n      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);\r\n      font-size: 16px;\r\n      color: #000000;\r\n      max-width: 320px;\r\n      line-height: 1.3;\r\n      border: 1px solid rgb(232, 232, 232);\r\n      cursor: pointer;\r\n    }\r\n    .saicf-pop-up-close{\r\n      background:none;\r\n      border:none;\r\n      outline:none;\r\n      font-weight:500;\r\n      color:rgb(163,163,163);\r\n      align-self:flex-end;\r\n      cursor:pointer;\r\n      margin-bottom:0;\r\n      transition: opacity 0.3s ease, transform 0.3s ease;\r\n    }\r\n\r\n    .saicf-pop-up-close:hover{\r\n      transform: scale(1.05);\r\n    }\r\n\r\n    .saicf-pop-up-close{\r\n      opacity:0;\r\n      pointer-events:none;\r\n    }\r\n    .saicf-pop-up-close.show{\r\n      opacity:1;\r\n      pointer-events:auto;\r\n    }\r\n\r\n    .saicf-pop-up-message{\r\n      opacity:0;\r\n      transform:translateY(6px);\r\n      transition:opacity .4s ease, transform .4s ease;\r\n    }\r\n    .saicf-pop-up-message.show{\r\n      opacity:1;\r\n      transform:translateY(0);\r\n    }\r\n\r\n    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ predefined-question chips â”€â”€â”€â”€â”€â”€â”€â”€â”€ */\r\n    .saicf-predefined-container{\r\n      display:flex;\r\n      flex-wrap:wrap-reverse;\r\n      justify-content: flex-end;\r\n      gap:8px;\r\n      padding:6px 10px;\r\n      padding-bottom: 0;\r\n      background: white;\r\n    }\r\n\r\n    .saicf-predefined-container::-webkit-scrollbar{display:none;}\r\n\r\n    .saicf-predefined-question{\r\n      flex:0 0 auto;\r\n      border: 1px solid #e8e8e8ff;\r\n      background: transparent;\r\n      color:#333;\r\n      border-radius:20px;\r\n      padding:6px 12px;\r\n      font-size:14px;\r\n      white-space:nowrap;\r\n      cursor:pointer;\r\n      transition:background-color .25s,transform .2s;\r\n    }\r\n    .saicf-predefined-question:hover{\r\n      background: #f1f1f1ff;\r\n      transform:translateY(-1px);\r\n    }\r\n\r\n    /* â€”â€”â€” busy/disabled visuals â€”â€”â€” */\r\n    .saicf-send-message[disabled] {\r\n      opacity: .5 !important;\r\n      cursor: not-allowed !important;\r\n    }\r\n    .saicf-chat-footer textarea:disabled {\r\n      background: #f5f5f5 !important;\r\n      cursor: not-allowed !important;\r\n    }\r\n    .saicf-predefined-question.is-disabled {\r\n      opacity: .5 !important;\r\n      pointer-events: none !important;\r\n    }\r\n\r\n    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Header actions: close \"X\" + three-dots menu â”€â”€â”€â”€â”€â”€â”€â”€â”€ */\r\n    .saicf-header-actions {\r\n      display: flex;\r\n      align-items: center;\r\n      gap: 6px;\r\n      position: relative; /* anchor menu below */\r\n    }\r\n\r\n    .saicf-ellipsis-btn {\r\n      background: none;\r\n      border: none;\r\n      color: inherit;\r\n      padding: 4px;\r\n      margin: 0;\r\n      cursor: pointer;\r\n      border-radius: 6px;\r\n      transition: background-color .2s ease, transform .2s ease;\r\n      font-size: 20px;\r\n    }\r\n    .saicf-ellipsis-btn:hover { transform: scale(1.08); }\r\n    .saicf-ellipsis-btn svg { width: 1.4em; height: 1.4em; display: block; }\r\n\r\n    .saicf-menu {\r\n      position: absolute;\r\n      top: calc(100% + 8px);\r\n      right: 0;\r\n      min-width: 160px;\r\n      background: #fff;\r\n      color: #1f2937;\r\n      border: 1px solid rgba(0,0,0,.08);\r\n      box-shadow: 0 8px 24px rgba(0,0,0,.15);\r\n      border-radius: 10px;\r\n      padding: 6px;\r\n      z-index: 2147483647; /* above header */\r\n      opacity: 0;\r\n      pointer-events: none;\r\n      transform: translateY(-6px);\r\n      transition: opacity .15s ease, transform .15s ease;\r\n    }\r\n    .saicf-menu.is-open {\r\n      opacity: 1;\r\n      pointer-events: auto;\r\n      transform: translateY(0);\r\n    }\r\n\r\n    .saicf-menu-item {\r\n      width: 100%;\r\n      display: flex;\r\n      align-items: center;\r\n      gap: 8px;\r\n      padding: 8px 10px;\r\n      border: 0;\r\n      background: transparent;\r\n      font: inherit;\r\n      color: inherit;\r\n      border-radius: 8px;\r\n      cursor: pointer;\r\n      text-align: left;\r\n    }\r\n    .saicf-menu-item:hover { background: #f3f4f6; }\r\n\r\n    .saicf-menu-item svg { width: 1em; height: 1em; display: block; }\r\n\r\n    @media (min-width: 769px) {\r\n      .saicf-chat-window {\r\n        width: min(430px, calc(100svw - 24px));\r\n        height: min(620px, calc(100svh - 24px));\r\n        max-height: calc(100svh - 24px);\r\n      }\r\n    }\r\n\r\n    @media (max-width: 768px) {\r\n      /* Hide the dim overlay; the window itself covers the screen */\r\n      .saicf-chat-overlay {\r\n        display: none !important;\r\n      }\r\n\r\n      /* Fullscreen chat window (slides up when .show is added) */\r\n      .saicf-chat-window {\r\n        position: fixed !important;\r\n        inset: 0 !important;\r\n        width: 100% !important;\r\n        height: 100% !important;\r\n        border-radius: 0 !important;\r\n        background: #ffffff !important;\r\n        opacity: 0 !important;\r\n        transform: translateY(100%) !important;\r\n        transition: opacity 0.75s ease, transform 0.75s ease !important;\r\n        display: flex !important;\r\n        flex-direction: column !important;\r\n      }\r\n\r\n      /* When opened */\r\n      .saicf-chat-window.show {\r\n        opacity: 1 !important;\r\n        transform: none !important;\r\n      }\r\n\r\n      /* Internal pieces tuned for fullscreen */\r\n      .saicf-chat-window .saicf-chat-header {\r\n        border-radius: 0 !important;\r\n      }\r\n\r\n      .saicf-chat-header {\r\n        padding: 12px 10px;\r\n        margin-bottom: 5px;\r\n      }\r\n      .saicf-chat-window .saicf-chat-body {\r\n        flex: 1 1 auto !important;\r\n        min-height: 0 !important;\r\n        overflow-y: auto !important;\r\n        -webkit-overflow-scrolling: touch !important;\r\n      }\r\n\r\n      /* Keep your existing mobile sizing for other bits */\r\n      .saicf-close-chat-widget-icon {\r\n        font-size: 22px;\r\n      }\r\n      .saicf-chat-title {\r\n        font-size: 18px;\r\n      }\r\n      .widget-user-message,\r\n      .widget-bot-message {\r\n        font-size: 17px;\r\n      }\r\n      .saicf-chat-widget-icon {\r\n        width: 70px;\r\n        height: 70px;\r\n      }\r\n      .saicf-pop-up-container {\r\n        right: 20px;\r\n        bottom: calc(30px + var(--widget-size));\r\n      }\r\n      .saicf-pop-up-container.align-left {\r\n        left: 20px !important;\r\n        right: auto !important;\r\n      }\r\n      .saicf-pop-up-message {\r\n        padding: 7px 10px;\r\n        font-size: 14px;\r\n      }\r\n      .saicf-chat-window.align-left {\r\n        left: 0 !important;\r\n        right: 0 !important;\r\n      }\r\n    }\r\n\r\n    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Loading Spinner â”€â”€â”€â”€â”€â”€â”€â”€â”€ */\r\n    .saicf-config-loading {\r\n      display: flex;\r\n      align-items: center;\r\n      justify-content: center;\r\n      flex: 1;\r\n      background: #fff;\r\n      min-height: 0;\r\n      border-radius: 0 0 16px 16px;\r\n    }\r\n\r\n    .saicf-config-spinner {\r\n      width: 32px;\r\n      height: 32px;\r\n      color: #5616ea;\r\n      animation: saicf-spin 1s linear infinite;\r\n    }\r\n\r\n    @keyframes saicf-spin {\r\n      to { transform: rotate(360deg); }\r\n    }\r\n\r\n    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Pre-chat Form â”€â”€â”€â”€â”€â”€â”€â”€â”€ */\r\n    .saicf-pre-chat-container {\r\n      display: flex;\r\n      flex-direction: column;\r\n      align-items: center;\r\n      justify-content: flex-start;\r\n      padding: 30px 24px;\r\n      flex: 1;\r\n      min-height: 0;\r\n      text-align: center;\r\n      background: #fff;\r\n      overflow-y: auto;\r\n      border-radius: 0 0 16px 16px;\r\n    }\r\n\r\n    .saicf-pre-chat-header {\r\n      margin-bottom: 24px;\r\n      flex-shrink: 0;\r\n    }\r\n\r\n    .saicf-pre-chat-icon {\r\n      width: 48px;\r\n      height: 48px;\r\n      margin-bottom: 12px;\r\n      color: #5616ea;\r\n    }\r\n\r\n    .saicf-pre-chat-header h3 {\r\n      font-size: 20px;\r\n      font-weight: 600;\r\n      color: #333;\r\n      margin: 0 0 6px 0;\r\n    }\r\n\r\n    .saicf-pre-chat-header p {\r\n      font-size: 14px;\r\n      color: #666;\r\n      margin: 0;\r\n    }\r\n\r\n    .saicf-pre-chat-fields {\r\n      width: 100%;\r\n      max-width: 320px;\r\n      display: flex;\r\n      flex-direction: column;\r\n      gap: 14px;\r\n      margin-bottom: 20px;\r\n    }\r\n\r\n    .saicf-pre-chat-field {\r\n      display: flex;\r\n      flex-direction: column;\r\n      text-align: left;\r\n    }\r\n\r\n    .saicf-pre-chat-field label {\r\n      font-size: 13px;\r\n      font-weight: 600;\r\n      color: #444;\r\n      margin-bottom: 5px;\r\n      text-transform: capitalize;\r\n    }\r\n\r\n    .saicf-pre-chat-field input {\r\n      padding: 11px 12px;\r\n      border: 1px solid #ddd;\r\n      border-radius: 8px;\r\n      font-size: 15px;\r\n      transition: border-color 0.2s ease, box-shadow 0.2s ease;\r\n      outline: none;\r\n      font-family: inherit;\r\n    }\r\n\r\n    .saicf-pre-chat-field input:focus {\r\n      border-color: currentColor;\r\n    }\r\n\r\n    .saicf-pre-chat-field input:disabled {\r\n      background-color: #f5f5f5;\r\n      cursor: not-allowed;\r\n    }\r\n\r\n    .saicf-pre-chat-field input::placeholder {\r\n      color: #999;\r\n    }\r\n\r\n    .saicf-pre-chat-submit {\r\n      background-color: #5616ea;\r\n      color: white;\r\n      border: none;\r\n      border-radius: 8px;\r\n      padding: 12px 28px;\r\n      font-size: 15px;\r\n      font-weight: 600;\r\n      cursor: pointer;\r\n      transition: background-color 0.2s ease, transform 0.2s ease;\r\n      display: flex;\r\n      align-items: center;\r\n      justify-content: center;\r\n      gap: 8px;\r\n      min-width: 140px;\r\n      font-family: inherit;\r\n    }\r\n\r\n    .saicf-pre-chat-submit:hover:not(:disabled) {\r\n      background-color: #4512c4;\r\n      transform: translateY(-1px);\r\n    }\r\n\r\n    .saicf-pre-chat-submit:disabled {\r\n      background-color: #ccc;\r\n      cursor: not-allowed;\r\n      transform: none;\r\n    }\r\n\r\n    .saicf-pre-chat-submit .saicf-btn-spinner {\r\n      width: 16px;\r\n      height: 16px;\r\n      border: 2px solid rgba(255,255,255,0.3);\r\n      border-top-color: #fff;\r\n      border-radius: 50%;\r\n      animation: saicf-spin 0.8s linear infinite;\r\n    }\r\n\r\n    @media (max-width: 768px) {\r\n      .saicf-pre-chat-container {\r\n        padding: 24px 20px;\r\n      }\r\n\r\n      .saicf-pre-chat-icon {\r\n        width: 40px;\r\n        height: 40px;\r\n      }\r\n\r\n      .saicf-pre-chat-header h3 {\r\n        font-size: 18px;\r\n      }\r\n\r\n      .saicf-pre-chat-fields {\r\n        max-width: 100%;\r\n      }\r\n    }\r\n  `;\r\n  shadowRoot.appendChild(styleTag);\r\n\r\n  const widgetRoot = document.createElement('div');\r\n  widgetRoot.id = 'widget-root';\r\n  shadowRoot.appendChild(widgetRoot);\r\n\r\n  if (typeof marked !== 'undefined') {\r\n    marked.setOptions({\r\n      gfm: true,\r\n      breaks: true,\r\n      headerIds: false,\r\n    });\r\n  }\r\n\r\n  let widgetConfig;\r\n  let promotingText = 'This website is powered by smart AI chatbots from Ultimo Bots.';\r\n  let preChatFields = [];\r\n  let requirePreChat = false;\r\n  const PRE_CHAT_KEY = `saicf-prechat-completed-${botId}`;\r\n  let preChatCompleted = localStorage.getItem(PRE_CHAT_KEY) === '1';\r\n  const startTime = Date.now();\r\n\r\n  try {\r\n    const hostPageUrl = encodeURIComponent(window.location.href);\r\n\r\n    const res = await fetch(\r\n      `https://portal.ultimo-bots.com/api/widget_configuration/${botId}?host_url=${hostPageUrl}`,\r\n      { cache: 'no-store' }\r\n    );\r\n\r\n    if (!res.ok) {\r\n      throw new Error(`HTTP ${res.status}`);\r\n    }\r\n    widgetConfig = await res.json();\r\n    promotingText = widgetConfig.promoting_text ?? promotingText;\r\n\r\n    // Check for pre-chat requirement\r\n    requirePreChat = widgetConfig.require_pre_chat === true;\r\n    let requiredFieldIds = [];\r\n    try {\r\n      requiredFieldIds = typeof widgetConfig.pre_chat_required_fields === 'string'\r\n        ? JSON.parse(widgetConfig.pre_chat_required_fields)\r\n        : widgetConfig.pre_chat_required_fields || [];\r\n    } catch {\r\n      requiredFieldIds = [];\r\n    }\r\n\r\n    if (requirePreChat && requiredFieldIds.length > 0) {\r\n      // Fetch warm lead parameters to get field details\r\n      try {\r\n        const warmLeadRes = await fetch(\r\n          `https://portal.ultimo-bots.com/api/warm_lead_function/${botId}`,\r\n          { cache: 'no-store' }\r\n        );\r\n        if (warmLeadRes.ok) {\r\n          const warmLeadData = await warmLeadRes.json();\r\n          const allParams = warmLeadData.bot_function_parameters || [];\r\n\r\n          // Filter to only the required fields\r\n          preChatFields = allParams.filter(p => requiredFieldIds.includes(p.id));\r\n\r\n          if (preChatFields.length === 0) {\r\n            requirePreChat = false;\r\n          }\r\n        } else {\r\n          requirePreChat = false;\r\n        }\r\n      } catch (err) {\r\n        console.error('Error fetching warm lead parameters:', err);\r\n        requirePreChat = false;\r\n      }\r\n    } else {\r\n      requirePreChat = false;\r\n    }\r\n  } catch (err) {\r\n    console.error('Widget config load failed â€“ widget aborted', err);\r\n    addUltimoBacklink(promotingText, false);\r\n    return;\r\n  }\r\n\r\n  const removePoweredBy     = widgetConfig.remove_powered_by       ?? false;\r\n  addUltimoBacklink(promotingText, removePoweredBy);\r\n\r\n  const themeColor          = widgetConfig.theme_color             || '#0082ba';\r\n  const hoverColor          = widgetConfig.button_hover_color      || '#0595d3';\r\n  const headerFontColor     = widgetConfig.header_font_color       || '#ffffff';\r\n  const welcomeMessages     = widgetConfig.welcome_message\r\n            ? Array.isArray(widgetConfig.welcome_message)\r\n              ? widgetConfig.welcome_message\r\n              : [widgetConfig.welcome_message]\r\n            : [\"\"];\r\n  const widgetHeaderText    = widgetConfig.header_text             || 'Chat with us!';\r\n  const widgetBorderRadius  = widgetConfig.widget_border_radius    ?? 50;\r\n  const widgetSize          = widgetConfig.widget_size             ?? 75;\r\n  const logo                = widgetConfig.header_icon_path        || null;\r\n  const icon                = widgetConfig.widget_icon_path        || null;\r\n  const popUpDelaySeconds   = widgetConfig.pop_up_delay_seconds    ?? 2;\r\n  const popUpMessages       = widgetConfig.pop_up_messages         ?? false;\r\n  const inputPlaceholder    = widgetConfig.input_placeholder       || 'Type your message...';\r\n  const avatar              = widgetConfig.avatar_icon_path        || null;\r\n  const fontFamily          = (widgetConfig.font_family && String(widgetConfig.font_family).trim())\r\n    || '\"DM Sans\", sans-serif';\r\n\r\n  ensureFontLoaded(fontFamily);\r\n  shadowRoot.host.style.setProperty('--saicf-font-family', fontFamily);\r\n\r\n  let isPulsing = false;\r\n  if (typeof widgetConfig.pulsing === 'boolean') {\r\n    isPulsing = widgetConfig.pulsing;\r\n  } else if (typeof widgetConfig.pulsing === 'string') {\r\n    isPulsing = widgetConfig.pulsing.toLowerCase() === 'true';\r\n  }\r\n\r\n  const horizontalAlignment = widgetConfig.widget_horizontal_alignment || 'right';\r\n  const verticalAlignment   = widgetConfig.widget_vertical_alignment   || 'bottom';\r\n\r\n  const chatWidgetIcon = document.createElement('div');\r\n  chatWidgetIcon.className = 'saicf-chat-widget-icon';\r\n  if (isPulsing) {\r\n    chatWidgetIcon.classList.add('pulsing');\r\n  }\r\n  if (!icon) {\r\n    chatWidgetIcon.style.backgroundColor = themeColor;\r\n    chatWidgetIcon.style.paddingBottom = '1px';\r\n  }\r\n  if (widgetBorderRadius != null) {\r\n    chatWidgetIcon.style.borderRadius = `${widgetBorderRadius}%`;\r\n  }\r\n  if (widgetSize != null) {\r\n    chatWidgetIcon.style.height = `${widgetSize}px`;\r\n    chatWidgetIcon.style.width = `${widgetSize}px`;\r\n\r\n    container.style.setProperty('--widget-size', `${widgetSize}px`);\r\n  }\r\n  if (icon) {\r\n    chatWidgetIcon.innerHTML = `\r\n      <img\r\n        src=\"${icon}\"\r\n        alt=\"Widget Icon\"\r\n        style=\"max-width: 100%; max-height: 100%; border-radius: ${widgetBorderRadius}%;\">\r\n    `;\r\n  } else {\r\n    chatWidgetIcon.innerHTML = `\r\n<div style=\"display:flex; justify-content:center; align-items:center; background-color: transparent; padding-top: 3px\">\r\n  <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"65%\" viewBox=\"0 0 24 24\" fill=\"currentColor\" class=\"size-6\">\r\n    <path fill-rule=\"evenodd\" d=\"M12 2.25c-2.429 0-4.817.178-7.152.521C2.87 3.061 1.5 4.795 1.5 6.741v6.018c0 1.946 1.37 3.68 3.348 3.97.877.129 1.761.234 2.652.316V21a.75.75 0 0 0 1.28.53l4.184-4.183a.39.39 0 0 1 .266-.112c2.006-.05 3.982-.22 5.922-.506 1.978-.29 3.348-2.023 3.348-3.97V6.741c0-1.947-1.37-3.68-3.348-3.97A49.145 49.145 0 0 0 12 2.25ZM8.25 8.625a1.125 1.125 0 1 0 0 2.25 1.125 1.125 0 0 0 0-2.25Zm2.625 1.125a1.125 1.125 0 1 1 2.25 0 1.125 1.125 0 0 1-2.25 0Zm4.875-1.125a1.125 1.125 0 1 0 0 2.25 1.125 1.125 0 0 0 0-2.25Z\" clip-rule=\"evenodd\" />\r\n  </svg>\r\n</div>\r\n`;\r\n  }\r\n  const chatOverlay = document.createElement('div');\r\n  chatOverlay.className = 'saicf-chat-overlay hidden';\r\n\r\n  const chatWindow = document.createElement('div');\r\n  chatWindow.className = 'saicf-chat-window hidden';\r\n\r\n  const logoHTML = logo\r\n    ? `<img src=\"${logo}\" alt=\"Chat Logo\"\r\n         style=\"height:30px;width:30px;border-radius:50%;object-fit:cover;\"/>`\r\n    : '';\r\n  const headerHTML = `\r\n    <div class=\"saicf-chat-header\" style=\"background-color:${themeColor};\">\r\n      <div class=\"saicf-chat-header-title\">\r\n        <div class=\"saicf-logo-message-container\">\r\n          ${logoHTML}\r\n          <span class=\"saicf-chat-title\" style=\"color:${headerFontColor};\">${widgetHeaderText}</span>\r\n        </div>\r\n\r\n        <div class=\"saicf-header-actions\" aria-label=\"Chat actions\">\r\n          <!-- three dots -->\r\n          <button class=\"saicf-ellipsis-btn\" aria-label=\"More actions\" title=\"More\">\r\n            <svg viewBox=\"0 0 448 512\" fill=\"${headerFontColor}\">\r\n              <path d=\"M120 256a56 56 0 1 1-112 0 56 56 0 1 1 112 0zm160 0a56 56 0 1 1-112 0 56 56 0 1 1 112 0zm160 0a56 56 0 1 1-112 0 56 56 0 1 1 112 0z\"/>\r\n            </svg>\r\n          </button>\r\n\r\n          <!-- close X (unchanged) -->\r\n          <button class=\"saicf-close-btn saicf-close-chat-widget-icon\" aria-label=\"Close chat\" style=\"color:${headerFontColor};\">\r\n            <svg viewBox=\"0 0 384 512\" style=\"height:32px;width:32px;fill:currentColor;\">\r\n              <path d=\"M310.6 361.4 233.3 284l77.3-77.3c12.5-12.5 12.5-32.8 0-45.3-12.5-12.5-32.8-12.5-45.3 0L188 238.7 110.7 161.4c-12.5-12.5-32.8-12.5-45.3 0-12.5 12.5-12.5 32.8 0 45.3l77.3 77.3-77.3 77.3c-12.5 12.5-12.5 32.8 0 45.3 12.5 12.5 32.8 12.5 45.3 0L188 327.3l77.3 77.3c12.5 12.5 32.8 12.5 45.3 0 12.5-12.5 12.5-32.8 0-45.3z\"/>\r\n            </svg>\r\n          </button>\r\n\r\n          <!-- dropdown menu -->\r\n          <div class=\"saicf-menu\" role=\"menu\" hidden>\r\n            <button class=\"saicf-menu-item saicf-menu-item--clear\" role=\"menuitem\">\r\n              <svg viewBox=\"0 0 448 512\" fill=\"currentColor\">\r\n                <path d=\"M135.2 17.7c2.9-10.7 12.7-17.7 23.8-17.7h129.9c11.1 0 20.9 7.1 23.8 17.7L328 32H432c8.8 0 16 7.2 16 16s-7.2 16-16 16H416 32 16C7.2 64 0 56.8 0 48S7.2 32 16 32H120l15.2-14.3zM64 96H384l-21.2 355.9c-1.5 25.1-22.3 44.1-47.4 44.1H132.6c-25.1 0-45.9-19-47.4-44.1L64 96z\"/>\r\n              </svg>\r\n              Clear chat\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  `;\r\n  const poweredByHTML = removePoweredBy\r\n    ? ''\r\n    : `\r\n        <div class=\"saicf-powered-by\">\r\n          <a class=\"saicf-powered-by-text\"\r\n            href=\"https://www.ultimo-bots.com\"\r\n            target=\"_blank\"\r\n            rel=\"noopener\"\r\n            title=\"${promotingText}\">\r\n            Powered by Ultimo Bots\r\n          </a>\r\n        </div>\r\n      `;\r\n\r\n  chatWindow.innerHTML = `\r\n    ${headerHTML}\r\n    <div class=\"saicf-config-loading\">\r\n      <svg class=\"saicf-config-spinner\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 512 512\" fill=\"currentColor\">\r\n        <path d=\"M304 48a48 48 0 1 0 -96 0 48 48 0 1 0 96 0zm0 416a48 48 0 1 0 -96 0 48 48 0 1 0 96 0zM48 304a48 48 0 1 0 0-96 48 48 0 1 0 0 96zm464-48a48 48 0 1 0 -96 0 48 48 0 1 0 96 0zM142.9 437A48 48 0 1 0 75 369.1 48 48 0 1 0 142.9 437zm0-294.2A48 48 0 1 0 75 75a48 48 0 1 0 67.9 67.9zM369.1 437A48 48 0 1 0 437 369.1 48 48 0 1 0 369.1 437z\"/>\r\n      </svg>\r\n    </div>\r\n    <div class=\"saicf-pre-chat-container hidden\">\r\n      <div class=\"saicf-pre-chat-header\">\r\n        <svg class=\"saicf-pre-chat-icon\" viewBox=\"0 0 640 512\" fill=\"currentColor\" xmlns=\"http://www.w3.org/2000/svg\">\r\n          <path d=\"M208 352c114.9 0 208-78.8 208-176S322.9 0 208 0S0 78.8 0 176c0 38.6 14.7 74.3 39.6 103.4c-3.5 9.4-8.7 17.7-14.2 24.7c-4.8 6.2-9.7 11-13.3 14.3c-1.8 1.6-3.3 2.9-4.3 3.7c-.5 .4-.9 .7-1.1 .8l-.2 .2 0 0 0 0C1 327.2-1.4 334.4 .8 340.9S9.1 352 16 352c21.8 0 43.8-5.6 62.1-12.5c9.2-3.5 17.8-7.4 25.3-11.4C134.1 343.3 169.8 352 208 352zM448 176c0 112.3-99.1 196.9-216.5 207C255.8 457.4 336.4 512 432 512c38.2 0 73.9-8.7 104.7-23.9c7.5 4 16 7.9 25.2 11.4c18.3 6.9 40.3 12.5 62.1 12.5c6.9 0 13.1-4.5 15.2-11.1c2.1-6.6-.2-13.8-5.8-17.9l0 0 0 0-.2-.2c-.2-.2-.6-.4-1.1-.8c-1-.8-2.5-2-4.3-3.7c-3.6-3.3-8.5-8.1-13.3-14.3c-5.5-7-10.7-15.4-14.2-24.7c24.9-29 39.6-64.7 39.6-103.4c0-92.8-84.9-168.9-192.6-175.5c.4 5.1 .6 10.3 .6 15.5z\"/>\r\n        </svg>\r\n        <h3>Before we start chatting</h3>\r\n        <p>Please provide your details to continue</p>\r\n      </div>\r\n      <div class=\"saicf-pre-chat-fields\"></div>\r\n      <button class=\"saicf-pre-chat-submit\" disabled>Start Chat</button>\r\n    </div>\r\n    <div class=\"saicf-chat-body hidden\"></div>\r\n    <div class=\"saicf-chat-footer hidden\">\r\n      <div class=\"saicf-predefined-container hidden\"></div>\r\n      ${poweredByHTML}\r\n      <div class=\"saicf-input-send-container\">\r\n        <textarea class=\"saicf-chat-input\" placeholder=\"${inputPlaceholder}\" rows=\"1\"></textarea>\r\n        <button class=\"saicf-send-message\" style=\"background-color:${themeColor};\" aria-label=\"Send message\">\r\n          <svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 384 512\" style=\"width: 16px; height: 16px; fill: ${headerFontColor};\">\r\n            <path d=\"M214.6 41.4c-12.5-12.5-32.8-12.5-45.3 0L7 203.6c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L160 140.3V464c0 17.7 14.3 32 32 32s32-14.3 32-32V140.3l107.6 108.7c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L214.6 41.4z\"/>\r\n          </svg>\r\n        </button>\r\n      </div>\r\n    </div>\r\n  `;\r\n\r\n  const popUpContainer = document.createElement('div');\r\n\r\n  (function zoomWidgetForWixMobile () {\r\n    if (window.screen.width > 600) return;\r\n\r\n    const vp = document.querySelector('meta[name=\"viewport\"][id=\"wixMobileViewport\"]');\r\n    if (!vp) return;\r\n\r\n    const m = /width\\s*=\\s*(\\d+)/i.exec(vp.content || '');\r\n    if (!m) return;\r\n\r\n    const forcedWidth = +m[1];\r\n\r\n    const physical    = window.screen.width;\r\n    if (physical <= forcedWidth) return;\r\n\r\n    const zoomFactor  = forcedWidth / physical;\r\n\r\n    container.style.zoom = zoomFactor;\r\n    container.style.setProperty('-moz-transform', `scale(${zoomFactor})`);\r\n    container.style.setProperty('-moz-transform-origin', 'top left');\r\n  })();\r\n\r\n  popUpContainer.className = 'saicf-pop-up-container hidden';\r\n\r\n  const popUpCloseBtn = document.createElement('button');\r\n  popUpCloseBtn.className = 'saicf-pop-up-close';\r\n  popUpCloseBtn.setAttribute('aria-label', 'Close pop-up message');\r\n  popUpCloseBtn.innerHTML = `\r\n    <svg viewBox=\"0 0 384 512\" style=\"height:1.5em; width:1.5em; fill:currentColor; margin-bottom: 2px;\">\r\n      <path d=\"M310.6 361.4 233.3 284l77.3-77.3c12.5-12.5 12.5-32.8 0-45.3-12.5-12.5-32.8-12.5-45.3 0L188 238.7 110.7 161.4c-12.5-12.5-32.8-12.5-45.3 0-12.5 12.5-12.5 32.8 0 45.3l77.3 77.3-77.3 77.3c-12.5 12.5-12.5 32.8 0 45.3 12.5 12.5 32.8 12.5 45.3 0L188 327.3l77.3 77.3c12.5 12.5 32.8 12.5 45.3 0 12.5-12.5 12.5-32.8 0-45.3z\"/>\r\n    </svg>\r\n  `;\r\n  popUpCloseBtn.style.backgroundColor = themeColor;\r\n  popUpCloseBtn.style.color = headerFontColor;\r\n  popUpCloseBtn.style.borderRadius = '50%';\r\n  popUpCloseBtn.style.padding = '0px';\r\n  popUpCloseBtn.style.width = '24px';\r\n  popUpCloseBtn.style.height = '24px';\r\n  popUpCloseBtn.style.display = 'flex';\r\n  popUpCloseBtn.style.alignItems = 'center';\r\n  popUpCloseBtn.style.justifyContent = 'center';\r\n  popUpContainer.appendChild(popUpCloseBtn);\r\n\r\n  welcomeMessages.forEach(msg => {\r\n    const msgEl = document.createElement('div');\r\n    msgEl.className = 'saicf-pop-up-message';\r\n    msgEl.innerHTML = msg.replace(/\\n/g, '<br>');\r\n    popUpContainer.appendChild(msgEl);\r\n\r\n    msgEl.addEventListener('click', () => {\r\n      // Only show welcome messages if pre-chat is completed or not required\r\n      if (!requirePreChat || preChatCompleted) {\r\n        ensureMarked().then(() => {\r\n          if (chatBody.querySelectorAll('.saicf-message-row').length === 0) {\r\n            welcomeMessages.forEach(msg => appendMessage(msg, 'bot'));\r\n          }\r\n        });\r\n      }\r\n      chatWindow.classList.remove('hidden');\r\n      forceReflow(chatWindow);\r\n      chatWindow.classList.add('show');\r\n      chatOverlay.classList.remove('hidden');\r\n\r\n      if (window.matchMedia('(max-width: 768px)').matches) {\r\n        document.body.classList.add('no-scroll');\r\n      }\r\n\r\n      widgetOpenedOnce = true;\r\n      markPopUpSeen();\r\n      hidePopUp();\r\n    });\r\n  });\r\n\r\n  widgetRoot.appendChild(chatWidgetIcon);\r\n  widgetRoot.appendChild(chatOverlay);\r\n  widgetRoot.appendChild(chatWindow);\r\n  widgetRoot.appendChild(popUpContainer);\r\n\r\n  if (horizontalAlignment === 'left') {\r\n    chatWidgetIcon.classList.add('align-left');\r\n    chatWindow.classList.add('align-left');\r\n    popUpContainer.classList.add('align-left');\r\n  }\r\n  if (verticalAlignment === 'elevated') {\r\n    chatWidgetIcon.classList.add('elevated');\r\n    chatWindow.classList.add('elevated');\r\n    popUpContainer.classList.add('elevated');\r\n  }\r\n\r\n  const dynamicStyleEl = document.createElement('style');\r\n  dynamicStyleEl.textContent = `\r\n    .saicf-chat-footer button:hover {\r\n      background-color: ${hoverColor} !important;\r\n    }\r\n    .widget-user-message {\r\n      background-color: ${themeColor} !important;\r\n    }\r\n    .saicf-loading-dots div {\r\n      background-color: ${themeColor} !important;\r\n    }\r\n    .saicf-config-spinner {\r\n      color: ${themeColor};\r\n    }\r\n    .saicf-pre-chat-submit {\r\n      background-color: ${themeColor} !important;\r\n    }\r\n    .saicf-pre-chat-submit:hover:not(:disabled) {\r\n      background-color: ${hoverColor} !important;\r\n    }\r\n    .saicf-pre-chat-icon {\r\n      fill: ${themeColor};\r\n    }\r\n    .saicf-pre-chat-field input:focus {\r\n      border-color: ${themeColor};\r\n      box-shadow: 0 0 0 3px ${themeColor}22;\r\n    }\r\n  `;\r\n  shadowRoot.appendChild(dynamicStyleEl);\r\n\r\n  const closeChatBtn   = chatWindow.querySelector('.saicf-close-btn');\r\n  const chatBody       = chatWindow.querySelector('.saicf-chat-body');\r\n  const chatFooter     = chatWindow.querySelector('.saicf-chat-footer');\r\n\r\n  // Wrap chatBody for scroll-down button positioning\r\n  const chatBodyWrapper = document.createElement('div');\r\n  chatBodyWrapper.className = 'saicf-chat-body-wrapper';\r\n  chatBody.parentElement.insertBefore(chatBodyWrapper, chatBody);\r\n  chatBodyWrapper.appendChild(chatBody);\r\n\r\n  // Create spacer + sentinel elements for scroll positioning\r\n  const bottomSpacerEl = document.createElement('div');\r\n  bottomSpacerEl.style.flexShrink = '0';\r\n  chatBody.appendChild(bottomSpacerEl);\r\n\r\n  const messagesEndEl = document.createElement('div');\r\n  chatBody.appendChild(messagesEndEl);\r\n\r\n  // Create scroll-down button\r\n  const scrollDownBtn = document.createElement('button');\r\n  scrollDownBtn.className = 'saicf-scroll-to-bottom-btn';\r\n  scrollDownBtn.setAttribute('aria-label', 'Scroll to latest');\r\n  scrollDownBtn.innerHTML = '<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 384 512\" width=\"14\" height=\"14\"><path d=\"M169.4 470.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 370.8V64c0-17.7-14.3-32-32-32s-32 14.3-32 32v306.7L54.6 265.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z\" fill=\"currentColor\"/></svg>';\r\n  scrollDownBtn.addEventListener('click', () => {\r\n    // Recalculate spacer, then smooth-scroll to the anchor position.\r\n    userScrolledAway = false;\r\n    programmaticScroll = true;\r\n    recalcSpacer();\r\n    const allUserMsgs = chatBody.querySelectorAll('.saicf-message-row.user');\r\n    const lastUserMsg = allUserMsgs[allUserMsgs.length - 1];\r\n    if (spacerActive && lastUserMsg) {\r\n      smoothScrollTarget = lastUserMsg.offsetTop - TOP_MARGIN;\r\n    } else {\r\n      smoothScrollTarget = chatBody.scrollHeight - chatBody.clientHeight;\r\n    }\r\n    chatBody.scrollTo({ top: smoothScrollTarget, behavior: 'smooth' });\r\n    scrollDownBtn.classList.remove('visible');\r\n  });\r\n  chatBodyWrapper.appendChild(scrollDownBtn);\r\n  const chatInput      = chatWindow.querySelector('.saicf-chat-footer textarea');\r\n  const sendMessageBtn = chatWindow.querySelector('.saicf-send-message');\r\n  const ellipsisBtn    = chatWindow.querySelector('.saicf-ellipsis-btn');\r\n  const actionsWrap    = chatWindow.querySelector('.saicf-header-actions');\r\n  const menu           = chatWindow.querySelector('.saicf-menu');\r\n  const clearBtn       = chatWindow.querySelector('.saicf-menu-item--clear');\r\n  const configLoading  = chatWindow.querySelector('.saicf-config-loading');\r\n  const preChatContainer = chatWindow.querySelector('.saicf-pre-chat-container');\r\n  const preChatFieldsContainer = chatWindow.querySelector('.saicf-pre-chat-fields');\r\n  const preChatSubmitBtn = chatWindow.querySelector('.saicf-pre-chat-submit');\r\n\r\n  // Pre-chat form state\r\n  const preChatFormValues = {};\r\n\r\n  // Function to render pre-chat form fields\r\n  function renderPreChatFields() {\r\n    preChatFieldsContainer.innerHTML = '';\r\n\r\n    preChatFields.forEach(field => {\r\n      const fieldWrapper = document.createElement('div');\r\n      fieldWrapper.className = 'saicf-pre-chat-field';\r\n\r\n      const label = document.createElement('label');\r\n      label.textContent = field.user_display || field.name;\r\n      label.setAttribute('for', `prechat-field-${field.id}`);\r\n\r\n      const input = document.createElement('input');\r\n      input.type = field.name.toLowerCase().includes('email') ? 'email' : 'text';\r\n      input.id = `prechat-field-${field.id}`;\r\n      input.placeholder = `Enter your ${(field.user_display || field.name).toLowerCase()}`;\r\n      input.required = true;\r\n\r\n      preChatFormValues[field.id] = '';\r\n\r\n      input.addEventListener('input', (e) => {\r\n        preChatFormValues[field.id] = e.target.value;\r\n        validatePreChatForm();\r\n      });\r\n\r\n      fieldWrapper.appendChild(label);\r\n      fieldWrapper.appendChild(input);\r\n      preChatFieldsContainer.appendChild(fieldWrapper);\r\n    });\r\n  }\r\n\r\n  // Function to validate pre-chat form\r\n  function validatePreChatForm() {\r\n    const allFilled = preChatFields.every(field => {\r\n      const value = preChatFormValues[field.id];\r\n      return value && value.trim() !== '';\r\n    });\r\n    preChatSubmitBtn.disabled = !allFilled;\r\n  }\r\n\r\n  // Function to submit pre-chat form\r\n  async function submitPreChatForm() {\r\n    preChatSubmitBtn.disabled = true;\r\n    preChatSubmitBtn.textContent = 'Submitting...';\r\n\r\n    try {\r\n      // Build params object matching chatModal.js format: {fieldName: value}\r\n      const params = {};\r\n      preChatFields.forEach(field => {\r\n        params[field.name] = preChatFormValues[field.id];\r\n      });\r\n\r\n      const response = await fetch('https://portal.ultimo-bots.com/api/leads/pre_chat', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          bot_id: botId,\r\n          session_id: sessionId,\r\n          params: params\r\n        })\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error('Failed to submit pre-chat form');\r\n      }\r\n\r\n      preChatCompleted = true;\r\n      localStorage.setItem(PRE_CHAT_KEY, '1');\r\n\r\n      // Transition to chat view\r\n      preChatContainer.classList.add('hidden');\r\n      chatBody.classList.remove('hidden');\r\n      chatFooter.classList.remove('hidden');\r\n\r\n      // Load chat history or show welcome messages\r\n      if (chatBody.querySelectorAll('.saicf-message-row').length === 0) {\r\n        await loadChatHistory();\r\n        if (chatBody.querySelectorAll('.saicf-message-row').length === 0) {\r\n          await ensureMarked();\r\n          welcomeMessages.forEach(msg => appendMessage(msg, 'bot'));\r\n        }\r\n      }\r\n    } catch (err) {\r\n      console.error('Error submitting pre-chat form:', err);\r\n      preChatSubmitBtn.textContent = 'Start Chat';\r\n      preChatSubmitBtn.disabled = false;\r\n    }\r\n  }\r\n\r\n  // Pre-chat submit handler\r\n  preChatSubmitBtn.addEventListener('click', () => {\r\n    submitPreChatForm();\r\n  });\r\n\r\n  // Hide loading spinner and show appropriate view (with 200ms minimum)\r\n  function initializeWidgetView() {\r\n    const elapsed = Date.now() - startTime;\r\n    const minDelay = 200;\r\n    const remainingDelay = Math.max(0, minDelay - elapsed);\r\n\r\n    setTimeout(() => {\r\n      configLoading.classList.add('hidden');\r\n\r\n      if (requirePreChat && !preChatCompleted) {\r\n        renderPreChatFields();\r\n        preChatContainer.classList.remove('hidden');\r\n      } else {\r\n        chatBody.classList.remove('hidden');\r\n        chatFooter.classList.remove('hidden');\r\n      }\r\n    }, remainingDelay);\r\n  }\r\n\r\n  // Initialize the widget view\r\n  initializeWidgetView();\r\n\r\nfunction toggleMenu(open) {\r\n  const willOpen = typeof open === 'boolean' ? open : !menu.classList.contains('is-open');\r\n  menu.classList.toggle('is-open', willOpen);\r\n  if (willOpen) {\r\n    menu.removeAttribute('aria-hidden');\r\n    menu.removeAttribute('hidden');\r\n  } else {\r\n    menu.setAttribute('aria-hidden', 'true');\r\n    menu.setAttribute('hidden', '');\r\n  }\r\n}\r\n\r\n\r\n  shadowRoot.addEventListener('click', (e) => {\r\n    if (!menu.classList.contains('is-open')) return;\r\n    if (actionsWrap.contains(e.target)) return;\r\n    toggleMenu(false);\r\n  });\r\n\r\n  shadowRoot.addEventListener('keydown', (e) => {\r\n    if (e.key === 'Escape' && menu.classList.contains('is-open')) toggleMenu(false);\r\n  });\r\n\r\n  ellipsisBtn.addEventListener('click', (e) => {\r\n    e.stopPropagation();\r\n    toggleMenu();\r\n  });\r\n\r\n  clearBtn.addEventListener('click', (e) => {\r\n    e.preventDefault();\r\n    toggleMenu(false);\r\n\r\n    sessionId = generateSessionId();\r\n    sessionStorage.setItem(`sessionId-${botId}`, sessionId);\r\n    sessionStorage.removeItem(`chat-history-${botId}`);\r\n\r\n    chatBody.innerHTML = '';\r\n\r\n    // Re-add spacer elements after clearing\r\n    chatBody.appendChild(bottomSpacerEl);\r\n    chatBody.appendChild(messagesEndEl);\r\n    bottomSpacerEl.style.height = '0px';\r\n    spacerActive = false;\r\n    programmaticScroll = false;\r\n    pendingUserScroll = false;\r\n\r\n    const loadingRow = chatBody.querySelector('.saicf-loading-row');\r\n    if (loadingRow) {\r\n      loadingRow.remove();\r\n    } else {\r\n      const legacyDots = chatBody.querySelector('.saicf-loading-dots');\r\n      if (legacyDots) legacyDots.remove();\r\n    }\r\n    resetStreamingBotMessage();\r\n\r\n    if (Array.isArray(welcomeMessages) && welcomeMessages.length) {\r\n      welcomeMessages.forEach(msg => appendMessage(msg, 'bot'));\r\n    }\r\n\r\n    chatInput.focus();\r\n  });\r\n\r\n  const _origCloseChat = closeChat;\r\n  closeChat = function () {\r\n    toggleMenu(false);\r\n    resetStreamingBotMessage();\r\n    _origCloseChat();\r\n  };\r\n\r\n  let isBusy = false;\r\n  let pendingUserScroll = false;\r\n  let spacerActive = false;\r\n  let programmaticScroll = false;\r\n  let isStreamingState = false;\r\n  let userScrolledAway = false;\r\n  let ignoreScrollEvents = false;\r\n  let smoothScrollTarget = null; // store target so completion check is exact\r\n  const TOP_MARGIN = 6;\r\n  const isMobile = window.matchMedia('(max-width: 768px)').matches;\r\n\r\n  // Recalculate spacer so user message stays at top.\r\n  // Key insight: lastUserMsg.offsetTop is CONSTANT during streaming\r\n  // (only content below it changes). So the target scrollTop is always\r\n  // lastUserMsg.offsetTop - TOP_MARGIN. Setting scrollTop to a value\r\n  // it already holds is a no-op (no event, no jitter).\r\n  function recalcSpacer() {\r\n    if (!bottomSpacerEl || !chatBody) return 0;\r\n    const allUserMsgs = chatBody.querySelectorAll('.saicf-message-row.user');\r\n    const lastUserMsg = allUserMsgs[allUserMsgs.length - 1];\r\n    if (!lastUserMsg) return 0;\r\n\r\n    const containerH = chatBody.clientHeight;\r\n    const msgOffsetTop = lastUserMsg.offsetTop;  // constant during streaming\r\n    const naturalContentH = bottomSpacerEl.offsetTop;\r\n    const contentBelowUserMsg = naturalContentH - msgOffsetTop;\r\n    const neededSpacer = Math.max(0, containerH - contentBelowUserMsg - TOP_MARGIN);\r\n    bottomSpacerEl.style.height = neededSpacer + 'px';\r\n    spacerActive = neededSpacer > 0;\r\n\r\n    // Anchor scroll so user msg stays at TOP_MARGIN from viewport top.\r\n    // msgOffsetTop is constant during streaming, so when already correct\r\n    // chatBody.scrollTop === target and the assignment is a true no-op.\r\n    // Skip when: user scrolled away, or desktop smooth scroll in progress.\r\n    if (spacerActive && !userScrolledAway && !programmaticScroll) {\r\n      const target = msgOffsetTop - TOP_MARGIN;\r\n      if (Math.abs(chatBody.scrollTop - target) > 1) {\r\n        ignoreScrollEvents = true;\r\n        chatBody.scrollTop = target;\r\n        requestAnimationFrame(() => { ignoreScrollEvents = false; });\r\n      }\r\n    }\r\n\r\n    return neededSpacer;\r\n  }\r\n\r\n  // Position user message at top after sending.\r\n  function doPositioning() {\r\n    if (!chatBody || !pendingUserScroll) return;\r\n    pendingUserScroll = false;\r\n\r\n    // Reset spacer for fresh measurement\r\n    bottomSpacerEl.style.height = '0px';\r\n    spacerActive = false;\r\n\r\n    // Size the spacer. Set programmaticScroll FIRST so recalcSpacer\r\n    // skips its instant anchor â€” we want a smooth scroll instead.\r\n    programmaticScroll = true;\r\n    recalcSpacer();\r\n\r\n    if (spacerActive) {\r\n      // Scroll to the exact anchor value (msgOffsetTop - TOP_MARGIN),\r\n      // not scrollHeight - clientHeight, so there's zero discrepancy\r\n      // when the smooth scroll completes.\r\n      const allUserMsgs = chatBody.querySelectorAll('.saicf-message-row.user');\r\n      const lastUserMsg = allUserMsgs[allUserMsgs.length - 1];\r\n      smoothScrollTarget = lastUserMsg ? lastUserMsg.offsetTop - TOP_MARGIN : 0;\r\n      chatBody.scrollTo({ top: smoothScrollTarget, behavior: 'smooth' });\r\n    } else {\r\n      programmaticScroll = false;\r\n    }\r\n  }\r\n\r\n  // Track scroll-down button visibility\r\n  function updateScrollDownVisibility() {\r\n    if (!chatBody) return;\r\n    // Hide during smooth scroll animation\r\n    if (programmaticScroll) {\r\n      scrollDownBtn.classList.remove('visible');\r\n      return;\r\n    }\r\n    const { scrollTop, scrollHeight, clientHeight } = chatBody;\r\n    const isAtBottom = scrollHeight - scrollTop - clientHeight < 40;\r\n    const shouldShow = !isAtBottom && scrollHeight > clientHeight;\r\n    scrollDownBtn.classList.toggle('visible', shouldShow);\r\n  }\r\n\r\n  // Scroll event handler\r\n  chatBody.addEventListener('scroll', function () {\r\n    if (ignoreScrollEvents) return;\r\n    if (programmaticScroll) {\r\n      // Detect smooth scroll completion: arrived at target or at bottom\r\n      const atTarget = smoothScrollTarget !== null && Math.abs(chatBody.scrollTop - smoothScrollTarget) < 2;\r\n      const atBottom = chatBody.scrollHeight - chatBody.scrollTop - chatBody.clientHeight < 2;\r\n      if (atTarget || atBottom) {\r\n        programmaticScroll = false;\r\n        smoothScrollTarget = null;\r\n      }\r\n      return;\r\n    }\r\n    updateScrollDownVisibility();\r\n  });\r\n\r\n  // Detect user-initiated scrolls via touch events (mobile) or\r\n  // wheel/mousedown (desktop). This is reliable on iOS where scroll\r\n  // events from programmatic scrollTop, keyboard dismiss, and resize\r\n  // are indistinguishable from user scrolls.\r\n  if (isMobile) {\r\n    let userTouching = false;\r\n    chatBody.addEventListener('touchstart', () => { userTouching = true; }, { passive: true });\r\n    chatBody.addEventListener('touchend', () => {\r\n      // Defer so the final scroll events from the touch are processed\r\n      setTimeout(() => { userTouching = false; }, 100);\r\n    }, { passive: true });\r\n    chatBody.addEventListener('scroll', function () {\r\n      if (userTouching && isStreamingState && !userScrolledAway) {\r\n        userScrolledAway = true;\r\n        updateScrollDownVisibility();\r\n      }\r\n    }, { passive: true });\r\n  } else {\r\n    // Desktop: wheel and mousedown are reliable indicators\r\n    chatBody.addEventListener('wheel', function () {\r\n      if (isStreamingState && !userScrolledAway) {\r\n        userScrolledAway = true;\r\n        updateScrollDownVisibility();\r\n      }\r\n    }, { passive: true });\r\n    chatBody.addEventListener('mousedown', function () {\r\n      if (isStreamingState && !userScrolledAway) {\r\n        userScrolledAway = true;\r\n        updateScrollDownVisibility();\r\n      }\r\n    });\r\n  }\r\n\r\n  // Watch for container resizes (e.g. mobile keyboard dismiss changes\r\n  // clientHeight). Re-size the spacer so the user message stays pinned.\r\n  let lastBodyHeight = chatBody.clientHeight;\r\n  const bodyResizeObserver = new ResizeObserver(() => {\r\n    const newH = chatBody.clientHeight;\r\n    if (newH === lastBodyHeight) return;\r\n    lastBodyHeight = newH;\r\n    if (spacerActive) {\r\n      recalcSpacer();\r\n    }\r\n  });\r\n  bodyResizeObserver.observe(chatBody);\r\n\r\n  function getPredefinedChips() {\r\n    return Array.from(chatWindow.querySelectorAll('.saicf-predefined-question'));\r\n  }\r\n\r\n  function setBusy(b) {\r\n    isBusy = b;\r\n\r\n    chatInput.disabled = b;\r\n    sendMessageBtn.disabled = b;\r\n    chatInput.setAttribute('aria-disabled', String(b));\r\n    sendMessageBtn.setAttribute('aria-disabled', String(b));\r\n\r\n    getPredefinedChips().forEach(chip => {\r\n      chip.classList.toggle('is-disabled', b);\r\n      chip.tabIndex = b ? -1 : 0;\r\n      chip.setAttribute('aria-disabled', String(b));\r\n    });\r\n  }\r\n\r\n  const predefinedContainer = chatWindow.querySelector('.saicf-predefined-container');\r\n\r\n  let predefinedQuestions = widgetConfig.predefined_questions ?? [];\r\n  try {\r\n    if (typeof predefinedQuestions === 'string') {\r\n      predefinedQuestions = JSON.parse(predefinedQuestions);\r\n    }\r\n  } catch {}\r\n\r\n  const hasRealQuestions =\r\n    Array.isArray(predefinedQuestions) &&\r\n    (predefinedQuestions.length > 1 ||\r\n    (predefinedQuestions.length === 1 && predefinedQuestions[0].trim() !== ''));\r\n\r\n  if (hasRealQuestions) {\r\n    predefinedContainer.classList.remove('hidden');\r\n\r\n    predefinedQuestions.forEach(q => {\r\n      if (!q) return;\r\n      const chip        = document.createElement('div');\r\n      chip.className    = 'saicf-predefined-question';\r\n      chip.textContent  = q;\r\n\r\n      chip.addEventListener('click', () => {\r\n        if (isBusy) return;\r\n        chatInput.value = q;\r\n        sendMessage();\r\n      });\r\n\r\n      predefinedContainer.appendChild(chip);\r\n    });\r\n  }\r\n\r\n  let sessionId = sessionStorage.getItem(`sessionId-${botId}`) || generateSessionId();\r\n  sessionStorage.setItem(`sessionId-${botId}`, sessionId);\r\n  let widgetOpenedOnce = popUpSeen;\r\n  let streamingBotRow = null;\r\n  let streamingBotBubble = null;\r\n\r\n  chatWidgetIcon.addEventListener('click', async () => {\r\n    // Only load chat history if pre-chat is completed or not required\r\n    if (!requirePreChat || preChatCompleted) {\r\n      if (chatBody.querySelectorAll('.saicf-message-row').length === 0) {\r\n        await loadChatHistory();\r\n        if (chatBody.querySelectorAll('.saicf-message-row').length === 0) {\r\n          await ensureMarked();\r\n          welcomeMessages.forEach(msg => appendMessage(msg, 'bot'));\r\n        }\r\n      }\r\n    }\r\n    chatWindow.classList.remove('hidden');\r\n    forceReflow(chatWindow);\r\n    chatWindow.classList.add('show');\r\n    chatOverlay.classList.remove('hidden');\r\n    if (window.matchMedia('(max-width: 768px)').matches) {\r\n      document.body.classList.add('no-scroll');\r\n    }\r\n    widgetOpenedOnce = true;\r\n    markPopUpSeen();\r\n    hidePopUp();\r\n  });\r\n\r\n  closeChatBtn.addEventListener('click', () => {\r\n    closeChat();\r\n  });\r\n\r\n  sendMessageBtn.addEventListener('click', () => {\r\n    if (isBusy) return;\r\n    sendMessage();\r\n  });\r\n\r\n  chatInput.addEventListener('keydown', (e) => {\r\n    if (e.key === 'Enter' && !e.shiftKey) {\r\n      e.preventDefault();\r\n      if (isBusy) return;\r\n      sendMessage();\r\n    }\r\n  });\r\n\r\n  chatInput.addEventListener('input', () => {\r\n    resizeTextarea(chatInput);\r\n  });\r\n\r\n  function resizeTextarea(el) {\r\n    el.style.height = 'auto';\r\n    const lineHeight = 24;\r\n    const maxLines = 5;\r\n    const padding = 20;\r\n    const maxHeight = (lineHeight * maxLines) + padding;\r\n    const minHeight = lineHeight + padding;\r\n    const newHeight = el.value ? Math.min(el.scrollHeight, maxHeight) : minHeight;\r\n    el.style.height = newHeight + 'px';\r\n    if (el.scrollHeight > maxHeight) {\r\n      el.classList.add('has-overflow');\r\n    } else {\r\n      el.classList.remove('has-overflow');\r\n    }\r\n  }\r\n\r\n  popUpCloseBtn.addEventListener('click', e => {\r\n    e.stopPropagation();\r\n    hidePopUp();\r\n    widgetOpenedOnce = true;\r\n    markPopUpSeen();\r\n  });\r\n\r\n  function showPopUpSequentially() {\r\n    if (widgetOpenedOnce || popUpSeen) return;\r\n    popUpContainer.classList.remove('hidden');\r\n\r\n    const msgs = popUpContainer.querySelectorAll('.saicf-pop-up-message');\r\n    msgs.forEach((msg, i) => {\r\n      setTimeout(() => {\r\n        msg.classList.add('show');\r\n        if (i === 0) {\r\n          popUpCloseBtn.classList.add('show');\r\n        }\r\n      }, i * 1200);\r\n    });\r\n  }\r\n\r\n  function hidePopUp() {\r\n    popUpContainer.classList.add('hidden');\r\n    popUpContainer.querySelectorAll('.saicf-pop-up-message')\r\n                  .forEach(m => m.classList.remove('show'));\r\n    popUpCloseBtn.classList.remove('show');\r\n  }\r\n\r\n  if (popUpMessages) {\r\n    setTimeout(showPopUpSequentially, popUpDelaySeconds * 1000);\r\n  }\r\n\r\n  function forceReflow(element) {\r\n    void element.offsetHeight;\r\n  }\r\n\r\n  function closeChat() {\r\n    chatWindow.classList.remove('show');\r\n    chatOverlay.classList.add('hidden');\r\n    if (window.matchMedia('(max-width: 768px)').matches) {\r\n      document.body.classList.remove('no-scroll');\r\n    }\r\n    setTimeout(() => chatWindow.classList.add('hidden'), 300);\r\n  }\r\n\r\n  function generateSessionId() {\r\n    const timestamp = new Date().getTime();\r\n    const randomNum = Math.floor(Math.random() * 10000) + 1;\r\n    return `${timestamp}-${randomNum}`;\r\n  }\r\n\r\n  async function sendMessage() {\r\n    if (isBusy) return;\r\n\r\n    const message = chatInput.value.trim();\r\n    if (!message) return;\r\n\r\n    // Set up scroll positioning flags\r\n    pendingUserScroll = true;\r\n    isStreamingState = true;\r\n    userScrolledAway = false;\r\n\r\n    appendMessage(message, 'user', { skipScroll: true });\r\n    chatInput.value = '';\r\n    resizeTextarea(chatInput);\r\n\r\n    setBusy(true);\r\n    setLoading(true);\r\n\r\n    // Trigger positioning after DOM is updated\r\n    doPositioning();\r\n\r\n    let currentBotMessage = '';\r\n    resetStreamingBotMessage();\r\n\r\n    const url =\r\n      `https://portal.ultimo-bots.com/api/chatbot_response?` +\r\n      `user_input=${encodeURIComponent(message)}` +\r\n      `&session_id=${sessionId}&bot_id=${botId}&language=english`;\r\n\r\n    const finish = () => {\r\n      setLoading(false);\r\n      setBusy(false);\r\n      isStreamingState = false;\r\n      saveChatHistory();\r\n      resetStreamingBotMessage();\r\n      recalcSpacer();\r\n      updateScrollDownVisibility();\r\n    };\r\n\r\n    // Error messages for different error types\r\n    const ERROR_MESSAGES = {\r\n      rate_limit: 'Too many requests. Please wait a moment before trying again.',\r\n      timeout: 'Sorry, the server took too long to respond. Please try again.',\r\n      internal_error: 'Something went wrong. Please try again later.',\r\n      validation_error: 'There was a problem with your request. Please try again.',\r\n      bot_not_found: 'This chatbot is currently unavailable.',\r\n      default: 'An unexpected error occurred. Please try again.'\r\n    };\r\n\r\n    return new Promise((resolve) => {\r\n      const es = new EventSource(url);\r\n      let firstChunk = true;\r\n      let hasError = false;\r\n\r\n      es.onmessage = ({ data: chunk }) => {\r\n        if (chunk === 'end of response') return;\r\n        if (firstChunk) {\r\n          // If smooth scroll is still animating, snap to final position\r\n          // BEFORE any DOM mutations. Removing loading dots drops\r\n          // scrollHeight, causing the browser to clamp scrollTop\r\n          // synchronously â€” disrupting the animation and shifting the\r\n          // user message down. By snapping first, we own the scrollTop\r\n          // value and recalcSpacer can re-anchor correctly.\r\n          if (programmaticScroll && !userScrolledAway) {\r\n            programmaticScroll = false;\r\n            smoothScrollTarget = null;\r\n            const allUserMsgs = chatBody.querySelectorAll('.saicf-message-row.user');\r\n            const lastUserMsg = allUserMsgs[allUserMsgs.length - 1];\r\n            if (lastUserMsg) {\r\n              ignoreScrollEvents = true;\r\n              chatBody.scrollTop = lastUserMsg.offsetTop - TOP_MARGIN;\r\n              requestAnimationFrame(() => { ignoreScrollEvents = false; });\r\n            }\r\n          } else if (programmaticScroll) {\r\n            // User scrolled away â€” just cancel the smooth scroll,\r\n            // don't snap them back to the user message.\r\n            programmaticScroll = false;\r\n            smoothScrollTarget = null;\r\n          }\r\n          setLoading(false);\r\n          firstChunk = false;\r\n        }\r\n        currentBotMessage += chunk.replace(/<newline>/g, '\\n');\r\n        updateStreamingBotMessage(currentBotMessage);\r\n      };\r\n\r\n      es.addEventListener('end', () => {\r\n        if (!hasError) {\r\n          updateStreamingBotMessage(currentBotMessage);\r\n        }\r\n        es.close();\r\n        finish();\r\n        resolve();\r\n      });\r\n\r\n      es.addEventListener('error', (e) => {\r\n        hasError = true;\r\n        es.close();\r\n        resetStreamingBotMessage();\r\n\r\n        // Parse the error data (now sent as JSON)\r\n        let errorType = 'default';\r\n        let errorMessage = ERROR_MESSAGES.default;\r\n\r\n        try {\r\n          if (e?.data) {\r\n            // Handle legacy format (plain string)\r\n            if (e.data === 'Timeout while generating response') {\r\n              errorType = 'timeout';\r\n            } else if (e.data === 'Internal server error') {\r\n              errorType = 'internal_error';\r\n            } else {\r\n              // Try to parse as JSON (new format)\r\n              const errorData = JSON.parse(e.data);\r\n              errorType = errorData.type || 'default';\r\n            }\r\n            errorMessage = ERROR_MESSAGES[errorType] || ERROR_MESSAGES.default;\r\n          }\r\n        } catch (parseError) {\r\n          // If JSON parsing fails, use default error message\r\n          console.warn('Could not parse error data:', e?.data);\r\n        }\r\n\r\n        appendMessage(errorMessage, 'bot');\r\n        finish();\r\n        resolve();\r\n      });\r\n\r\n      // Handle EventSource connection errors (network issues, etc.)\r\n      es.onerror = (e) => {\r\n        // Only handle if not already handled by 'error' event listener\r\n        if (hasError) return;\r\n\r\n        // EventSource will auto-reconnect by default - we don't want that for errors\r\n        if (es.readyState === EventSource.CLOSED) {\r\n          hasError = true;\r\n          resetStreamingBotMessage();\r\n          appendMessage(ERROR_MESSAGES.default, 'bot');\r\n          finish();\r\n          resolve();\r\n        } else if (es.readyState === EventSource.CONNECTING) {\r\n          // Connection lost, close and show error\r\n          hasError = true;\r\n          es.close();\r\n          resetStreamingBotMessage();\r\n          appendMessage('Connection lost. Please try again.', 'bot');\r\n          finish();\r\n          resolve();\r\n        }\r\n      };\r\n    });\r\n  }\r\n\r\n  function createMessageRow(text, sender) {\r\n    const row = document.createElement('div');\r\n    row.className = `saicf-message-row ${sender}`;\r\n    row.dataset.sender = sender;\r\n\r\n    if (sender === 'bot' && avatar) {\r\n      const avatarEl = document.createElement('div');\r\n      avatarEl.className = 'saicf-message-avatar';\r\n      avatarEl.style.backgroundImage = `url(\"${avatar}\")`;\r\n      row.appendChild(avatarEl);\r\n    }\r\n\r\n    const bubble = document.createElement('div');\r\n    bubble.className = `saicf-widget-message widget-${sender}-message`;\r\n    if (typeof marked !== 'undefined') {\r\n      bubble.innerHTML = marked.parse(text);\r\n    } else {\r\n      bubble.textContent = text;\r\n    }\r\n    row.appendChild(bubble);\r\n    return row;\r\n  }\r\n\r\n  function appendMessage(text, sender, options = {}) {\r\n    const row = createMessageRow(text, sender);\r\n    chatBody.insertBefore(row, bottomSpacerEl);\r\n    if (!options.skipScroll) {\r\n      scrollToBottom();\r\n    }\r\n    if (!options.skipSave) {\r\n      saveChatHistory();\r\n    }\r\n    return row;\r\n  }\r\n\r\n  function resetStreamingBotMessage() {\r\n    streamingBotRow = null;\r\n    streamingBotBubble = null;\r\n  }\r\n\r\n  function ensureStreamingBotBubble() {\r\n    if (!streamingBotBubble || !streamingBotBubble.isConnected) {\r\n      streamingBotRow = appendMessage('', 'bot', { skipScroll: true, skipSave: true });\r\n      streamingBotBubble = streamingBotRow\r\n        ? streamingBotRow.querySelector('.widget-bot-message')\r\n        : null;\r\n    }\r\n    return streamingBotBubble;\r\n  }\r\n\r\n  function updateStreamingBotMessage(text) {\r\n    const bubble = ensureStreamingBotBubble();\r\n    if (!bubble) return;\r\n    if (typeof marked !== 'undefined') {\r\n      bubble.innerHTML = marked.parse(text);\r\n    } else {\r\n      bubble.textContent = text;\r\n    }\r\n    // Shrink spacer as bot response grows + re-anchor scroll.\r\n    // recalcSpacer is a no-op when scrollTop is already correct\r\n    // (lastUserMsg.offsetTop is constant), so no jitter.\r\n    if (spacerActive && !programmaticScroll && !userScrolledAway) {\r\n      recalcSpacer();\r\n    }\r\n    updateScrollDownVisibility();\r\n  }\r\n\r\n  function scrollToBottom() {\r\n    chatBody.scrollTop = chatBody.scrollHeight;\r\n  }\r\n\r\n  function setLoading(isLoading) {\r\n    const existing = chatBody.querySelector('.saicf-loading-row');\r\n    if (isLoading) {\r\n      if (existing) return;\r\n      const row = document.createElement('div');\r\n      row.className = 'saicf-loading-row';\r\n      row.innerHTML = '<div class=\"saicf-loading-dots\"><div></div><div></div><div></div></div>';\r\n      chatBody.insertBefore(row, bottomSpacerEl);\r\n      // Only auto-scroll if doPositioning won't handle it\r\n      if (!pendingUserScroll) scrollToBottom();\r\n    } else if (existing) {\r\n      existing.remove();\r\n      if (spacerActive) recalcSpacer();\r\n    }\r\n  }\r\n\r\n  function saveChatHistory() {\r\n    const messages = Array.from(chatBody.querySelectorAll('.saicf-message-row'))\r\n      .filter(row => !row.classList.contains('saicf-loading-row'))\r\n      .map(row => {\r\n        const bubble = row.querySelector('.saicf-widget-message');\r\n        const text = bubble ? bubble.innerHTML : '';\r\n        return {\r\n          text: text,\r\n          sender: row.dataset.sender\r\n        };\r\n      });\r\n    const data = JSON.stringify(messages);\r\n    sessionStorage.setItem(`chat-history-${botId}`, data);\r\n  }\r\n\r\n  async function loadChatHistory() {\r\n    const saved = sessionStorage.getItem(`chat-history-${botId}`);\r\n    if (!saved) {\r\n      return;\r\n    }\r\n\r\n    await ensureMarked();\r\n\r\n    try {\r\n      const messages = JSON.parse(saved);\r\n\r\n      messages.forEach((msg) => {\r\n        const row = document.createElement('div');\r\n        row.className = `saicf-message-row ${msg.sender}`;\r\n        row.dataset.sender = msg.sender;\r\n\r\n        if (msg.sender === 'bot' && avatar) {\r\n          const avatarEl = document.createElement('div');\r\n          avatarEl.className = 'saicf-message-avatar';\r\n          avatarEl.style.backgroundImage = `url(\"${avatar}\")`;\r\n          row.appendChild(avatarEl);\r\n        }\r\n\r\n        const bubble = document.createElement('div');\r\n        bubble.className = `saicf-widget-message widget-${msg.sender}-message`;\r\n\r\n        // Set the HTML directly - it's already processed\r\n        if (msg.text) {\r\n          bubble.innerHTML = msg.text;\r\n        } else {\r\n          bubble.textContent = '(empty message)';\r\n        }\r\n\r\n        row.appendChild(bubble);\r\n        chatBody.insertBefore(row, bottomSpacerEl);\r\n      });\r\n\r\n      scrollToBottom();\r\n    } catch (error) {\r\n      console.error('Failed to load chat history:', error);\r\n      sessionStorage.removeItem(`chat-history-${botId}`);\r\n    }\r\n  }\r\n}\r\n\n\n//# sourceURL=webpack://swiss_bot_widget/./src/index.js?");

/***/ })

/******/ 	});
/************************************************************************/
/******/ 	
/******/ 	// startup
/******/ 	// Load entry module and return exports
/******/ 	// This entry module can't be inlined because the eval devtool is used.
/******/ 	var __webpack_exports__ = {};
/******/ 	__webpack_modules__["./src/index.js"]();
/******/ 	
/******/ })()
;