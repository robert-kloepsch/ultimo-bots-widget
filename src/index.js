/*********************************************************
 * index.js
 * Renders the chat widget in a Shadow DOM at #chat-widget-container
 *********************************************************/
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeChatWidget);
} else {
  initializeChatWidget();
}

async function initializeChatWidget() {
  const container = document.getElementById('chat-widget-container');
  if (!container) {
    console.error('Chat widget container not found');
    return;
  }

  if (container.parentElement !== document.body) {
    document.body.appendChild(container);
  }

  container.style.position = 'relative';
  container.style.zIndex  = '2147483647';

  const botId = container.getAttribute('data-user-id');
  if (!botId) {
    console.error('User ID not found (data-user-id is missing)');
    return;
  }

  const shadowRoot = container.attachShadow({ mode: 'open' });

  if (!document.getElementById('saicf-global-scroll-style')) {
    const globalScrollStyle = document.createElement('style');
    globalScrollStyle.id = 'saicf-global-scroll-style';
    globalScrollStyle.textContent = `
      body.no-scroll,
      html.no-scroll {
        overflow: hidden !important;
        position: fixed !important;
        inset: 0 !important;
        width: 100% !important;
        touch-action: none !important;
        overscroll-behavior: none !important;
      }
    `;
    document.head.appendChild(globalScrollStyle);
  }

  const styleTag = document.createElement('style');
  styleTag.textContent = `
    /**********************************************************
     * Embedded widget.css (now isolated to this Shadow DOM)
     **********************************************************/
    :host, .saicf-chat-window, .saicf-chat-window * {
      font-family: "DM Sans", sans-serif !important;
    }

    :host {
      --widget-size: 80px; /* fallback â€“ will be overwritten by JS */
    }

    .saicf-chat-window p {
      line-height: 1.3 !important;
      font-size: 15px !important;
    }
    .saicf-chat-widget-icon {
      position: fixed;
      bottom: 20px;
      right: 20px;
      color: white;
      border-radius: 50%;
      width: 100px;
      height: 100px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      font-size: 36px;
      z-index: 999998 !important;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    .pulsing {
      animation: pulse 2s infinite;
    }
    .saicf-chat-title {
      font-size: 15px;
      font-weight: 600;
    }
    .saicf-chat-window {
      position: fixed;
      bottom: 12px;
      right: 12px;
      width: 400px;
      height: 550px;
      background-color: transparent;
      border: none;
      border-radius: 16px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      display: flex !important;
      flex-direction: column;
      z-index: 2147483647 !important;
      opacity: 0;
      transform: translateY(100%);
      transition: opacity 0.5s ease, transform 0.5s ease;
    }
    .saicf-chat-window.show {
      opacity: 1;
      transform: translateY(0);
    }
    .hidden {
      display: none;
    }
    .saicf-chat-header {
      color: white;
      padding: 10px 15px;
      border-radius: 16px 16px 0px 0px;
      display: flex;
      flex-direction: column;
    }
    .saicf-chat-header-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .saicf-logo-message-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .saicf-close-btn {
      background: none;
      border: none;
      color: rgb(218, 43, 43);
      margin: 0;
      padding: 0;
      outline: none;
      cursor: pointer;
    }
    .saicf-close-chat-widget-icon {
      font-size: 20px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    .saicf-close-chat-widget-icon:hover {
      transform: scale(1.2);
    }
    .saicf-chat-body {
      flex: 1;
      padding: 8px;
      padding-top: 0;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      background-color: white;
    }
    .saicf-chat-footer {
      display: flex;
      flex-direction: column;
      padding: 10px;
      background-color: white;
      gap: 8px;
    }
    .saicf-powered-by {
      display: flex;
      justify-content: center;
    }
    .saicf-powered-by-text {
      font-size: 10px;
      color: rgb(146, 146, 146);
      cursor: pointer;
      text-decoration: underline;
    }
    .saicf-input-send-container {
      display: flex;
      border-top: 1px solid #ccc;
      padding-top: 10px;
    }
    .saicf-chat-footer input {
      flex: 1 !important;
      padding: 7px !important;
      border: 1px solid #ccc !important;
      border-radius: 8px !important;
      outline: none !important;
      font-size: 16px !important;
    }
    .saicf-chat-footer button {
      display: flex;
      align-items: center;
      margin-left: 6px;
      padding-left: 15px;
      padding-right: 15px;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: background-color 0.4s ease, transform 0.2s ease;
    }
    .saicf-chat-footer button:hover {
      background-color: #0595d3;
      transform: translateY(-1.5px);
    }
    .saicf-widget-message {
      max-width: 80%;
      margin: 5px 0;
      padding: 5px;
      border-radius: 10px;
      display: inline-block;
    }
    .widget-user-message {
      align-self: flex-end !important;
      color: white !important;
      border-radius: 8px !important;
      padding: 8px !important;
      font-size: 15px !important;
    }
    .widget-bot-message {
      align-self: flex-start !important;
      background-color: #ffffff !important;
      color: rgb(43, 43, 43) !important;
      border-radius: 8px;
      font-size: 15px !important;
    }
    .widget-bot-message strong {
      color: rgb(57, 57, 57);
    }
    .widget-bot-message ul li:not(:last-child) {
      margin-bottom: 6px;
    }
    .widget-user-message > :first-child,
    .widget-bot-message > :first-child {
      margin: 0;
    }
    .widget-user-message > :last-child,
    .widget-bot-message > :last-child {
      margin: 0;
    }
    .saicf-widget-send-icon {
      font-size: 18px;
      font-style: normal;
    }
    .saicf-loading-dots {
      display: flex;
      justify-content: left;
      align-items: center;
      height: 40px;
      margin-top: 10px;
      margin-bottom: 5px;
    }
    .saicf-loading-dots div {
      width: 8px;
      height: 8px;
      margin: 0 4px;
      border-radius: 50%;
      animation: loading 0.6s infinite alternate;
    }
    @keyframes loading {
      to {
        opacity: 0.3;
        transform: translateY(-8px);
      }
    }
    .saicf-loading-dots div:nth-child(2) {
      animation-delay: 0.2s;
    }
    .saicf-loading-dots div:nth-child(3) {
      animation-delay: 0.4s;
    }
    .saicf-chat-widget-icon.align-left {
      left: 25px !important;
      right: auto !important;
    }
    .saicf-chat-widget-icon.elevated {
      bottom: 55px !important;
    }
    .saicf-chat-window.align-left {
      left: 20px !important;
      right: auto !important;
    }
    .saicf-chat-window.elevated {
      bottom: 12px !important;
    }
    .saicf-widget-message table {
      border-collapse: separate;
      border-spacing: 0px;
      margin-top: 15px;
      margin-bottom: 15px;
      width: 100%;
      overflow: auto;
    }
    .saicf-widget-message th, .saicf-widget-message td {
      border: 1px solid rgba(0, 0, 0, 0.08);
      padding: .35rem .50rem;
      text-align: left;
      font-size: 14px;
    }
    .saicf-widget-message th {
      color: #000000;
      background-color: rgba(0, 0, 0, 0.06);
      border-right: 0;
      padding: .5rem .50rem;
      border-bottom: none;
    }
    .saicf-widget-message th:last-child {
      border-right: 1px solid rgba(0, 0, 0, 0.08);
    }
    .saicf-widget-message td {
      border-bottom: 0px solid rgba(0, 0, 0, 0.08);
      border-right: 0px solid rgba(0, 0, 0, 0.08);
    }
    .saicf-widget-message td:last-child {
      border-right: 1px solid rgba(0, 0, 0, 0.08);
    }
    .saicf-widget-message tr:first-child th:first-child {
      border-top-left-radius: 8px;
    }
    .saicf-widget-message tr:first-child th:last-child {
      border-top-right-radius: 8px;
    }
    .saicf-widget-message tr:last-child td:first-child {
      border-bottom-left-radius: 8px;
    }
    .saicf-widget-message tr:last-child td:last-child {
      border-bottom-right-radius: 8px;
    }
    .saicf-widget-message tr:last-child td {
      border-bottom: 1px solid rgba(0, 0, 0, 0.08);
    }

    /**********************************************************
     * Pop-up message styles
     **********************************************************/
    .saicf-pop-up-container {
      position: fixed;
      right: 20px;
      bottom: calc(30px + var(--widget-size));
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 999999;
    }
    .saicf-pop-up-container.hidden {
      pointer-events: none;
    }
    .saicf-pop-up-container.align-left {
      left: 25px !important;
      right: auto !important;
    }
    .saicf-pop-up-message {
      background:rgb(250, 250, 250);
      padding: 8px 12px;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      font-size: 15px;
      color: #000000;
      max-width: 320px;
      line-height: 1.3;
      border: 1px solid rgb(232, 232, 232);
      cursor: pointer;
    }
    .saicf-pop-up-close{
      background:none;
      border:none;
      outline:none;
      font-size:17px;
      font-weight:500;
      color:rgb(163,163,163);
      align-self:flex-end;
      cursor:pointer;
      margin-top:-4px;
      margin-bottom:0;
      transform:scale(1);
      transition:transform 0.5s ease;
    }

    .saicf-pop-up-close:hover{
      transform:scale(1.08);
    }

    .saicf-pop-up-close{
      opacity:0;
      pointer-events:none;
      transition:opacity .3s ease;
    }
    .saicf-pop-up-close.show{
      opacity:1;
      pointer-events:auto;
    }

    .saicf-pop-up-message{
      opacity:0;
      transform:translateY(6px);
      transition:opacity .4s ease, transform .4s ease;
    }
    .saicf-pop-up-message.show{
      opacity:1;
      transform:translateY(0);
    }

    @media (max-width: 768px) {
      .saicf-chat-overlay {
        position: fixed;
        background: rgba(0, 0, 0, 0.2);
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 999999;
      }
      .saicf-chat-window {
        position: fixed;
        left: 4%;
        bottom: 1%;
        width: 92%;
        height: 82%;
        border-radius: 16px;
        transition: opacity 0.6s ease, transform 0.6s ease;
      }
      body.no-scroll {
        overflow: hidden;
      }
      .saicf-close-chat-widget-icon {
        font-size: 22px;
      }
      .saicf-chat-title {
        font-size: 16px;
      }
      .widget-user-message {
        font-size: 17px;
      }
      .widget-bot-message {
        font-size: 17px;
      }
      .saicf-chat-widget-icon {
        width: 70px;
        height: 70px;
      }
      .saicf-pop-up-container {
        right: 20px;
        bottom: calc(30px + var(--widget-size));
      }
      .saicf-pop-up-container.align-left {
        left: 20px !important;
        right: auto !important;
      }
      .saicf-pop-up-message {
        padding: 7px 10px;
        font-size: 14px;
      }
    }
  `;
  shadowRoot.appendChild(styleTag);

  const widgetRoot = document.createElement('div');
  widgetRoot.id = 'widget-root';
  shadowRoot.appendChild(widgetRoot);

  if (typeof marked !== 'undefined') {
    marked.setOptions({
      gfm: true,
      breaks: true,
      headerIds: false,
    });
  }

  function getBrowserLanguage() {
    return navigator.language || navigator.userLanguage || 'en';
  }
  const browserLanguage = getBrowserLanguage();

  let widgetConfig = {};
  try {
    const response = await fetch(`https://portal.ultimo-bots.com/api/widget_configuration/${botId}`);
    widgetConfig = await response.json();
  } catch (error) {
    console.error('Error fetching widget configuration:', error);
  }
  console.log(widgetConfig.welcome_message)

  const themeColor          = widgetConfig.theme_color             || '#0082ba';
  const hoverColor          = widgetConfig.button_hover_color      || '#0595d3';
  const headerFontColor     = widgetConfig.header_font_color       || '#ffffff';
  const welcomeMessages     = widgetConfig.welcome_message
            ? Array.isArray(widgetConfig.welcome_message)
              ? widgetConfig.welcome_message
              : [widgetConfig.welcome_message]
            : [""];
  const widgetHeaderText    = widgetConfig.header_text             || 'Chat with us!';
  const widgetBorderRadius  = widgetConfig.widget_border_radius    ?? 50;
  const widgetSize          = widgetConfig.widget_size             ?? 75;
  const logo                = widgetConfig.header_icon_path        || null;
  const icon                = widgetConfig.widget_icon_path        || null;
  const popUpDelaySeconds   = widgetConfig.pop_up_delay_seconds    ?? 2;

  let isPulsing = false;
  if (typeof widgetConfig.pulsing === 'boolean') {
    isPulsing = widgetConfig.pulsing;
  } else if (typeof widgetConfig.pulsing === 'string') {
    isPulsing = widgetConfig.pulsing.toLowerCase() === 'true';
  }

  const horizontalAlignment = widgetConfig.widget_horizontal_alignment || 'right';
  const verticalAlignment   = widgetConfig.widget_vertical_alignment   || 'bottom';

  const chatWidgetIcon = document.createElement('div');
  chatWidgetIcon.className = 'saicf-chat-widget-icon';
  if (isPulsing) {
    chatWidgetIcon.classList.add('pulsing');
  }
  if (!icon) {
    chatWidgetIcon.style.backgroundColor = themeColor;
    chatWidgetIcon.style.paddingBottom = '1px';
  }
  if (widgetBorderRadius != null) {
    chatWidgetIcon.style.borderRadius = `${widgetBorderRadius}%`;
  }
  if (widgetSize != null) {
    chatWidgetIcon.style.height = `${widgetSize}px`;
    chatWidgetIcon.style.width = `${widgetSize}px`;

    container.style.setProperty('--widget-size', `${widgetSize}px`);
  }
  if (icon) {
    chatWidgetIcon.innerHTML = `
      <img
        src="${icon}"
        alt="Widget Icon"
        style="max-width: 100%; max-height: 100%; border-radius: ${widgetBorderRadius}%;">
    `;
  } else {
    chatWidgetIcon.innerHTML = `
      <div style="display:flex; justify-content:center; align-items:center; background-color: transparent">
            <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px"
            width="100%" viewBox="0 0 1048 1048" enableBackground="new 0 0 1048 1048">
            <path fill="none" opacity="1.000000" stroke="none"
                d="
            M551.000000,1049.000000
                C367.355103,1049.000000 184.210220,1049.000000 1.032671,1049.000000
                C1.032671,699.729980 1.032671,350.459961 1.032671,1.094980
                C350.228455,1.094980 699.456909,1.094980 1048.842773,1.094980
                C1048.842773,350.333282 1048.842773,699.666626 1048.842773,1049.000000
                C883.126160,1049.000000 717.313049,1049.000000 551.000000,1049.000000
            M843.577148,722.017639
                C850.069946,709.949890 857.028198,698.104431 862.927185,685.753113
                C869.046631,672.940308 875.070435,659.939392 879.441223,646.470764
                C884.625732,630.494873 888.612305,614.056458 891.972656,597.584900
                C894.827881,583.588989 896.167419,569.275208 897.948914,555.073303
                C898.646606,549.511047 898.989685,543.872192 899.025024,538.265259
                C899.107361,525.217468 899.363159,512.143555 898.671692,499.126801
                C898.122803,488.793579 896.556458,478.484344 894.926392,468.246521
                C893.044922,456.429169 891.010315,444.604492 888.262573,432.967072
                C886.166199,424.088562 883.046814,415.430084 880.037537,406.793915
                C875.884583,394.875336 871.994080,382.810120 866.898621,371.291016
                C862.057007,360.345856 856.237244,349.765930 850.071045,339.491455
                C842.526550,326.920349 834.268738,314.771240 826.147278,302.553986
                C815.167297,286.036499 801.526672,271.849640 787.569641,257.827759
                C768.018250,238.185455 746.431335,221.244965 722.944763,206.720505
                C711.739258,199.790863 700.251038,193.171844 688.354797,187.545700
                C675.571899,181.500198 662.222473,176.622101 648.999878,171.548218
                C640.942810,168.456497 632.813904,165.292969 624.443054,163.332932
                C608.201538,159.529968 591.942383,155.932495 575.336121,153.545654
                C559.213379,151.228302 543.120483,150.582581 526.988586,150.126968
                C508.963501,149.617889 490.937134,150.516586 473.142975,153.969742
                C456.750275,157.150909 440.136749,159.485092 424.022766,163.722260
                C410.416199,167.300095 397.141815,172.496887 384.165741,178.022919
                C369.420532,184.302338 355.095886,191.593994 340.724030,198.719131
                C323.759033,207.129852 308.259094,217.939484 293.652222,229.843170
                C281.086365,240.083527 268.742401,250.779633 257.545654,262.467285
                C245.248138,275.303986 233.897171,289.137024 223.035263,303.230743
                C214.570862,314.213654 207.137375,326.047577 199.910858,337.908508
                C194.948303,346.053558 190.878036,354.778381 186.859146,363.452667
                C182.352722,373.179199 178.054077,383.025879 174.215836,393.031555
                C170.163712,403.594818 166.229202,414.260803 163.229340,425.153442
                C160.416534,435.366943 159.017731,445.962433 156.772919,456.341461
                C153.304153,472.379456 150.823273,488.515625 150.984497,504.979218
                C151.002335,506.800293 150.796417,508.622375 150.749969,510.445404
                C150.517654,519.564636 149.708160,528.718262 150.224365,537.795959
                C150.983353,551.142456 152.510330,564.456238 154.066254,577.742310
                C155.019073,585.878540 156.400970,593.984863 158.033722,602.014465
                C159.304413,608.263489 161.143356,614.407410 162.936600,620.537537
                C166.231354,631.800110 169.171799,643.204102 173.205688,654.202209
                C177.179626,665.036865 182.358109,675.427612 186.950439,686.038025
                C194.625671,703.771545 204.330124,720.362976 215.549210,736.042847
                C223.180588,746.708496 231.322281,757.008301 239.161102,767.527283
                C239.981415,768.628113 240.923752,770.202576 240.740982,771.393311
                C239.672775,778.352417 238.173584,785.244202 237.032593,792.193665
                C235.200974,803.349792 233.582657,814.540771 231.786774,825.703003
                C229.752197,838.348633 227.374451,850.944275 225.596573,863.624817
                C223.508881,878.515015 239.975601,889.288391 251.800400,884.943481
                C255.564148,883.560547 259.074188,881.483826 262.843079,880.118652
                C275.258514,875.621887 287.775574,871.405273 300.184906,866.892090
                C312.635345,862.363953 325.084351,857.808533 337.354492,852.823242
                C340.700256,851.463989 342.999023,852.418213 345.669739,853.752136
                C353.378235,857.602295 361.027344,861.584961 368.851135,865.186829
                C376.373840,868.650146 383.988739,871.960571 391.738159,874.872192
                C402.101593,878.766052 412.502899,882.666992 423.131317,885.716675
                C433.187653,888.602112 443.511841,890.636719 453.803802,892.595825
                C464.768799,894.682983 475.779510,897.173584 486.867889,897.824280
                C505.547882,898.920471 524.304321,898.883484 543.029846,898.948914
                C550.449280,898.974854 557.923889,898.384338 565.281311,897.392273
                C576.175598,895.923340 587.085510,894.288330 597.811096,891.919739
                C612.132874,888.757019 626.347290,885.049500 640.480469,881.117920
                C646.710938,879.384766 652.639221,876.553223 658.684753,874.169861
                C669.393494,869.948059 680.561340,866.584106 690.675537,861.232971
                C705.764587,853.249817 720.234009,844.058716 734.733093,835.006836
                C752.018127,824.215759 767.589783,811.131348 782.286011,797.109192
                C805.638123,774.828308 826.165100,750.151245 843.577148,722.017639
            z"/>
            <path fill="#C3C3C3" opacity="1.000000" stroke="none"
                d="
            M843.354370,722.314392
                C826.165100,750.151245 805.638123,774.828308 782.286011,797.109192
                C767.589783,811.131348 752.018127,824.215759 734.733093,835.006836
                C720.234009,844.058716 705.764587,853.249817 690.675537,861.232971
                C680.561340,866.584106 669.393494,869.948059 658.684753,874.169861
                C652.639221,876.553223 646.710938,879.384766 640.480469,881.117920
                C626.347290,885.049500 612.132874,888.757019 597.811096,891.919739
                C587.085510,894.288330 576.175598,895.923340 565.281311,897.392273
                C557.923889,898.384338 550.449280,898.974854 543.029846,898.948914
                C524.304321,898.883484 505.547882,898.920471 486.867889,897.824280
                C475.779510,897.173584 464.768799,894.682983 453.803802,892.595825
                C443.511841,890.636719 433.187653,888.602112 423.131317,885.716675
                C412.502899,882.666992 402.101593,878.766052 391.738159,874.872192
                C383.988739,871.960571 376.373840,868.650146 368.851135,865.186829
                C361.027344,861.584961 353.378235,857.602295 345.669739,853.752136
                C342.999023,852.418213 340.700256,851.463989 337.354492,852.823242
                C325.084351,857.808533 312.635345,862.363953 300.184906,866.892090
                C287.775574,871.405273 275.258514,875.621887 262.843079,880.118652
                C259.074188,881.483826 255.564148,883.560547 251.800400,884.943481
                C239.975601,889.288391 223.508881,878.515015 225.596573,863.624817
                C227.374451,850.944275 229.752197,838.348633 231.786774,825.703003
                C233.582657,814.540771 235.200974,803.349792 237.032593,792.193665
                C238.173584,785.244202 239.672775,778.352417 240.740982,771.393311
                C240.923752,770.202576 239.981415,768.628113 239.161102,767.527283
                C231.322281,757.008301 223.180588,746.708496 215.549210,736.042847
                C204.330124,720.362976 194.625671,703.771545 186.950439,686.038025
                C182.358109,675.427612 177.179626,665.036865 173.205688,654.202209
                C169.171799,643.204102 166.231354,631.800110 162.936600,620.537537
                C161.143356,614.407410 159.304413,608.263489 158.033722,602.014465
                C156.400970,593.984863 155.019073,585.878540 154.066254,577.742310
                C152.510330,564.456238 150.983353,551.142456 150.224365,537.795959
                C149.708160,528.718262 150.517654,519.564636 150.749969,510.445404
                C150.796417,508.622375 151.002335,506.800293 150.984497,504.979218
                C150.823273,488.515625 153.304153,472.379456 156.772919,456.341461
                C159.017731,445.962433 160.416534,435.366943 163.229340,425.153442
                C166.229202,414.260803 170.163712,403.594818 174.215836,393.031555
                C178.054077,383.025879 182.352722,373.179199 186.859146,363.452667
                C190.878036,354.778381 194.948303,346.053558 199.910858,337.908508
                C207.137375,326.047577 214.570862,314.213654 223.035263,303.230743
                C233.897171,289.137024 245.248138,275.303986 257.545654,262.467285
                C268.742401,250.779633 281.086365,240.083527 293.652222,229.843170
                C308.259094,217.939484 323.759033,207.129852 340.724030,198.719131
                C355.095886,191.593994 369.420532,184.302338 384.165741,178.022919
                C397.141815,172.496887 410.416199,167.300095 424.022766,163.722260
                C440.136749,159.485092 456.750275,157.150909 473.142975,153.969742
                C490.937134,150.516586 508.963501,149.617889 526.988586,150.126968
                C543.120483,150.582581 559.213379,151.228302 575.336121,153.545654
                C591.942383,155.932495 608.201538,159.529968 624.443054,163.332932
                C632.813904,165.292969 640.942810,168.456497 648.999878,171.548218
                C662.222473,176.622101 675.571899,181.500198 688.354797,187.545700
                C700.251038,193.171844 711.739258,199.790863 722.944763,206.720505
                C746.431335,221.244965 768.018250,238.185455 787.569641,257.827759
                C801.526672,271.849640 815.167297,286.036499 826.147278,302.553986
                C834.268738,314.771240 842.526550,326.920349 850.071045,339.491455
                C856.237244,349.765930 862.057007,360.345856 866.898621,371.291016
                C871.994080,382.810120 875.884583,394.875336 880.037537,406.793915
                C883.046814,415.430084 886.166199,424.088562 888.262573,432.967072
                C891.010315,444.604492 893.044922,456.429169 894.926392,468.246521
                C896.556458,478.484344 898.122803,488.793579 898.671692,499.126801
                C899.363159,512.143555 899.107361,525.217468 899.025024,538.265259
                C898.989685,543.872192 898.646606,549.511047 897.948914,555.073303
                C896.167419,569.275208 894.827881,583.588989 891.972656,597.584900
                C888.612305,614.056458 884.625732,630.494873 879.441223,646.470764
                C875.070435,659.939392 869.046631,672.940308 862.927185,685.753113
                C857.028198,698.104431 850.069946,709.949890 843.354370,722.314392
            M422.199615,863.106140
                C431.372192,865.701355 440.470886,868.611267 449.741974,870.786621
                C456.476318,872.366821 463.422455,873.100830 470.303040,873.988281
                C480.941315,875.360291 491.582245,876.794067 502.263641,877.723877
                C511.004120,878.484802 519.810608,878.930115 528.577942,878.808105
                C536.492126,878.697998 544.398071,877.684326 552.298584,876.970032
                C563.170166,875.987122 574.214417,875.809937 584.858337,873.666931
                C601.453735,870.325562 617.975037,866.277527 634.162292,861.332703
                C654.497559,855.120728 674.089478,846.640747 692.655212,836.327026
                C707.411926,828.129333 721.765930,818.953552 735.289551,808.860046
                C749.025085,798.608337 761.819214,787.020630 774.453125,775.395874
                C781.906372,768.538025 788.523560,760.701050 795.017456,752.889343
                C802.546875,743.831970 810.334595,734.824707 816.564270,724.889099
                C826.502380,709.038879 835.699585,692.675598 844.333191,676.073181
                C849.935425,665.299988 854.293579,653.835876 858.621521,642.457764
                C862.170410,633.127747 865.474670,623.614563 867.761047,613.917053
                C870.629578,601.749878 872.660034,589.357483 874.477234,576.977783
                C876.325317,564.387451 878.180847,551.727966 878.782471,539.039490
                C880.034973,512.625977 877.481018,486.363373 872.679565,460.415833
                C870.139954,446.691833 866.187988,433.213318 862.511353,419.722717
                C860.832031,413.560547 858.465698,407.561188 856.079285,401.621246
                C851.542114,390.328339 847.337952,378.847107 841.931213,367.973267
                C836.373962,356.796661 829.475281,346.292114 823.289368,335.421936
                C811.509338,314.721375 796.389404,296.513428 779.833679,279.662750
                C767.454651,267.063171 753.797302,255.654846 740.177979,244.356247
                C725.839233,232.460785 710.090637,222.493820 693.463135,214.063538
                C682.803406,208.658936 671.964294,203.569839 660.996887,198.821579
                C651.208557,194.583786 641.329224,190.361664 631.142761,187.280655
                C612.541077,181.654343 593.774719,176.463470 574.286072,174.693924
                C560.965820,173.484482 547.670715,171.783752 534.324158,171.152985
                C524.912109,170.708160 515.424011,172.128159 505.985168,171.941330
                C487.841431,171.582184 470.113892,174.803940 452.553955,178.383728
                C430.877655,182.802689 409.554474,188.979736 389.267731,197.991425
                C375.900177,203.929474 362.479248,210.007858 349.920898,217.440506
                C334.492371,226.571854 319.485107,236.577499 305.153870,247.347076
                C294.430756,255.405258 284.577881,264.798035 275.221771,274.453369
                C263.959839,286.075470 252.942917,298.071655 243.069504,310.869873
                C229.161346,328.898102 216.762604,348.046356 207.554504,369.016357
                C201.519424,382.760315 194.991913,396.362762 190.106125,410.519104
                C182.720047,431.919800 176.650558,453.747589 174.762497,476.514404
                C173.832733,487.725586 171.288086,498.894531 171.336227,510.074615
                C171.418259,529.126587 172.622269,548.198120 174.041351,567.210205
                C174.814224,577.565002 176.334976,587.970642 178.711197,598.072815
                C181.873276,611.516113 185.814926,624.812012 190.136642,637.935791
                C193.989594,649.636108 198.062759,661.377563 203.383560,672.454895
                C211.828918,690.037231 220.304581,707.694763 232.224670,723.363281
                C240.585190,734.352905 248.284088,745.896484 257.274078,756.335144
                C261.697784,761.471741 262.534637,766.228760 261.443420,772.239624
                C259.553406,782.650391 257.762390,793.080200 256.054230,803.522400
                C254.480530,813.142578 253.131287,822.799316 251.571625,832.421875
                C249.887604,842.811890 248.074203,853.180969 246.155899,864.512085
                C256.181213,860.784851 265.111847,857.480774 274.030457,854.144409
                C284.943787,850.061707 295.864288,845.997131 306.748810,841.838684
                C314.450806,838.896179 322.073578,835.746277 329.777344,832.808655
                C336.730469,830.157166 343.371185,827.725342 350.965790,832.219299
                C361.791290,838.625122 372.927277,844.684937 384.459564,849.668579
                C396.444794,854.847961 409.059448,858.570801 422.199615,863.106140
            z"/>
            <path fill="#FFFFFF" opacity="1.000000" stroke="none"
                d="
            M421.799255,863.018311
                C409.059448,858.570801 396.444794,854.847961 384.459564,849.668579
                C372.927277,844.684937 361.791290,838.625122 350.965790,832.219299
                C343.371185,827.725342 336.730469,830.157166 329.777344,832.808655
                C322.073578,835.746277 314.450806,838.896179 306.748810,841.838684
                C295.864288,845.997131 284.943787,850.061707 274.030457,854.144409
                C265.111847,857.480774 256.181213,860.784851 246.155899,864.512085
                C248.074203,853.180969 249.887604,842.811890 251.571625,832.421875
                C253.131287,822.799316 254.480530,813.142578 256.054230,803.522400
                C257.762390,793.080200 259.553406,782.650391 261.443420,772.239624
                C262.534637,766.228760 261.697784,761.471741 257.274078,756.335144
                C248.284088,745.896484 240.585190,734.352905 232.224670,723.363281
                C220.304581,707.694763 211.828918,690.037231 203.383560,672.454895
                C198.062759,661.377563 193.989594,649.636108 190.136642,637.935791
                C185.814926,624.812012 181.873276,611.516113 178.711197,598.072815
                C176.334976,587.970642 174.814224,577.565002 174.041351,567.210205
                C172.622269,548.198120 171.418259,529.126587 171.336227,510.074615
                C171.288086,498.894531 173.832733,487.725586 174.762497,476.514404
                C176.650558,453.747589 182.720047,431.919800 190.106125,410.519104
                C194.991913,396.362762 201.519424,382.760315 207.554504,369.016357
                C216.762604,348.046356 229.161346,328.898102 243.069504,310.869873
                C252.942917,298.071655 263.959839,286.075470 275.221771,274.453369
                C284.577881,264.798035 294.430756,255.405258 305.153870,247.347076
                C319.485107,236.577499 334.492371,226.571854 349.920898,217.440506
                C362.479248,210.007858 375.900177,203.929474 389.267731,197.991425
                C409.554474,188.979736 430.877655,182.802689 452.553955,178.383728
                C470.113892,174.803940 487.841431,171.582184 505.985168,171.941330
                C515.424011,172.128159 524.912109,170.708160 534.324158,171.152985
                C547.670715,171.783752 560.965820,173.484482 574.286072,174.693924
                C593.774719,176.463470 612.541077,181.654343 631.142761,187.280655
                C641.329224,190.361664 651.208557,194.583786 660.996887,198.821579
                C671.964294,203.569839 682.803406,208.658936 693.463135,214.063538
                C710.090637,222.493820 725.839233,232.460785 740.177979,244.356247
                C753.797302,255.654846 767.454651,267.063171 779.833679,279.662750
                C796.389404,296.513428 811.509338,314.721375 823.289368,335.421936
                C829.475281,346.292114 836.373962,356.796661 841.931213,367.973267
                C847.337952,378.847107 851.542114,390.328339 856.079285,401.621246
                C858.465698,407.561188 860.832031,413.560547 862.511353,419.722717
                C866.187988,433.213318 870.139954,446.691833 872.679565,460.415833
                C877.481018,486.363373 880.034973,512.625977 878.782471,539.039490
                C878.180847,551.727966 876.325317,564.387451 874.477234,576.977783
                C872.660034,589.357483 870.629578,601.749878 867.761047,613.917053
                C865.474670,623.614563 862.170410,633.127747 858.621521,642.457764
                C854.293579,653.835876 849.935425,665.299988 844.333191,676.073181
                C835.699585,692.675598 826.502380,709.038879 816.564270,724.889099
                C810.334595,734.824707 802.546875,743.831970 795.017456,752.889343
                C788.523560,760.701050 781.906372,768.538025 774.453125,775.395874
                C761.819214,787.020630 749.025085,798.608337 735.289551,808.860046
                C721.765930,818.953552 707.411926,828.129333 692.655212,836.327026
                C674.089478,846.640747 654.497559,855.120728 634.162292,861.332703
                C617.975037,866.277527 601.453735,870.325562 584.858337,873.666931
                C574.214417,875.809937 563.170166,875.987122 552.298584,876.970032
                C544.398071,877.684326 536.492126,878.697998 528.577942,878.808105
                C519.810608,878.930115 511.004120,878.484802 502.263641,877.723877
                C491.582245,876.794067 480.941315,875.360291 470.303040,873.988281
                C463.422455,873.100830 456.476318,872.366821 449.741974,870.786621
                C440.470886,868.611267 431.372192,865.701355 421.799255,863.018311
            M260.240265,569.944397
                C260.027344,574.269958 259.650848,578.594788 259.631531,582.921204
                C259.567566,597.245239 261.180603,611.235413 268.994690,623.741638
                C278.046265,638.228577 295.303558,644.427612 312.734192,639.587036
                C328.831390,635.116638 338.142761,620.098694 339.813568,603.570984
                C339.919373,602.524231 338.104462,600.445435 336.957153,600.262268
                C333.028778,599.635315 328.957458,599.921387 325.019470,599.332336
                C320.084839,598.594299 316.502747,599.034790 316.558197,605.276794
                C316.570953,606.710876 315.847565,608.173584 315.356934,609.586243
                C312.654053,617.368225 307.983826,621.150330 301.384827,620.952637
                C294.851624,620.756775 289.724762,616.733521 287.884064,608.975952
                C283.859985,592.016052 284.040741,574.911743 288.246735,558.016602
                C290.184265,550.233826 295.963196,545.915771 302.385254,546.048279
                C308.967377,546.184021 313.721985,550.532166 315.779572,558.738770
                C316.742096,562.577942 317.169373,566.551270 317.929291,570.989807
                C325.238861,570.407410 332.383392,569.838135 340.254181,569.210999
                C339.054016,563.059021 338.372406,557.777161 336.966705,552.695679
                C332.798828,537.629211 323.439636,528.224548 307.394684,526.233398
                C290.542023,524.142090 275.610931,530.444031 268.399963,544.563599
                C264.540802,552.120117 262.980255,560.850586 260.240265,569.944397
            M460.815887,419.257721
                C457.186066,431.305206 453.556244,443.352692 449.749481,455.987366
                C456.817047,455.987366 463.131622,456.156738 469.422058,455.842987
                C470.665039,455.780975 472.496857,454.065063 472.888763,452.760864
                C474.465515,447.512726 475.736267,442.157257 476.809418,436.779480
                C477.371307,433.963806 478.599915,432.916870 481.489288,432.973633
                C489.476440,433.130615 497.470703,433.130157 505.457855,432.973206
                C508.153870,432.920227 509.314240,433.956970 509.868652,436.473663
                C511.049011,441.831818 512.311829,447.179474 513.812744,452.454041
                C514.187256,453.770386 515.557861,455.759491 516.533142,455.796570
                C523.934631,456.077789 531.351685,455.950409 539.585815,455.950409
                C528.830566,418.418732 518.324341,381.755890 507.790497,344.996796
                C500.850891,344.996796 494.525299,345.217499 488.224976,344.913910
                C484.451599,344.732086 482.758606,345.849060 481.646973,349.661011
                C474.942719,372.651184 467.922089,395.549133 460.815887,419.257721
            M379.479950,613.500183
                C379.576202,603.343994 379.446259,593.178894 379.846588,583.034668
                C380.123474,576.017334 383.467316,572.994568 389.679932,573.058960
                C395.147430,573.115540 397.019226,575.298767 397.118408,583.074402
                C397.328644,599.559570 397.257080,616.048157 397.326904,632.535217
                C397.335175,634.493469 397.504303,636.451050 397.613251,638.706787
                C405.254913,638.706787 412.494232,638.706787 420.012573,638.706787
                C420.143555,637.052673 420.361694,635.579041 420.361389,634.105408
                C420.358002,617.284668 420.403992,600.463135 420.241302,583.643677
                C420.194824,578.837219 419.864227,573.977234 419.049316,569.247620
                C417.796387,561.975891 413.241119,557.368286 406.035095,555.758850
                C396.301117,553.584839 387.600311,555.597351 379.513916,564.307190
                C379.513916,551.354492 379.513916,539.865417 379.513916,528.396240
                C371.413757,528.396240 364.193970,528.396240 356.784790,528.396240
                C356.784790,565.362732 356.784790,601.923706 356.784790,638.703125
                C364.387299,638.703125 371.617950,638.703125 379.479370,638.703125
                C379.479370,630.426941 379.479370,622.463623 379.479950,613.500183
            M643.281311,576.366943
                C642.000305,573.306396 641.070312,570.034790 639.378662,567.221130
                C631.173157,553.572388 616.384216,551.184204 604.199463,561.344604
                C603.760376,561.710693 603.160950,561.884521 601.778015,562.578796
                C601.778015,550.645935 601.778015,539.447876 601.778015,528.228516
                C594.111816,528.228516 587.148926,528.228516 579.832214,528.228516
                C579.832214,565.171326 579.832214,601.877258 579.832214,638.937256
                C584.053101,638.937256 588.479126,640.133484 591.495178,638.584534
                C594.243408,637.173035 595.462036,632.783203 597.593262,629.318665
                C601.675781,637.095337 607.820007,640.948547 616.280151,641.010803
                C628.693420,641.102173 637.510193,634.845764 641.976135,621.969604
                C647.082275,607.248047 646.922668,592.218445 643.281311,576.366943
            M445.820465,636.774963
                C451.781006,640.951721 458.331390,641.771240 465.349792,640.384766
                C472.450836,638.981934 477.152710,634.211548 481.617218,628.156738
                C482.309265,632.291077 482.843719,635.483948 483.377777,638.674500
                C490.456451,638.674500 497.033569,638.674500 503.204010,638.674500
                C503.204010,632.369812 503.223175,626.422729 503.200165,620.475830
                C503.147339,606.822144 503.108063,593.168274 502.997223,579.515076
                C502.919403,569.929565 499.491058,562.020447 490.207581,558.220276
                C477.093140,552.851807 464.091064,553.504944 452.004547,561.284302
                C445.212280,565.656067 441.784668,572.296936 440.948456,580.828430
                C448.248535,581.560730 455.125031,582.250549 462.147797,582.955017
                C462.761780,580.768311 463.159363,579.003723 463.752411,577.307556
                C465.336670,572.776184 468.598328,570.673706 473.365143,571.106689
                C478.212677,571.546997 479.504272,575.047424 479.945099,579.140503
                C480.105286,580.627686 480.010712,582.144165 480.198669,583.626221
                C480.589478,586.707214 479.457275,587.829895 476.224640,588.370117
                C468.549622,589.652649 460.591858,590.607056 453.452240,593.457275
                C436.544586,600.207031 432.326630,623.852905 445.820465,636.774963
            M723.566345,620.917908
                C728.066833,606.194702 728.359680,591.364746 723.994934,576.622559
                C719.717346,562.174927 709.358521,555.033813 693.576721,555.000427
                C677.562744,554.966553 667.134705,562.181152 662.814575,576.854126
                C658.723206,590.750244 658.726196,604.828918 662.715454,618.749146
                C666.735046,632.774780 676.328369,640.187439 690.682678,640.948303
                C707.116272,641.819397 717.427673,635.707520 723.566345,620.917908
            M746.934814,589.508179
                C747.277405,601.154602 747.243591,612.828491 748.090820,624.438110
                C748.687805,632.618958 753.931763,638.276123 761.810120,639.625854
                C768.556946,640.781738 775.657043,640.009399 782.591248,639.787842
                C783.583252,639.756104 785.294067,638.068420 785.352966,637.069397
                C785.641663,632.173767 785.483887,627.251892 785.483887,621.992249
                C782.958801,621.992249 781.308716,622.020752 779.659912,621.987366
                C771.772339,621.827698 769.545593,619.753357 769.309875,611.886841
                C769.125244,605.725525 769.214661,599.555603 769.200867,593.389526
                C769.187561,587.445923 769.197998,581.502319 769.197998,575.575439
                C770.567444,575.305969 771.196594,575.127625 771.837158,575.065125
                C775.868958,574.671936 781.885498,575.738464 783.449829,573.576111
                C785.544373,570.681030 784.191162,565.291443 784.316772,560.972900
                C784.321594,560.806641 784.295776,560.638794 784.307312,560.473328
                C784.484375,557.932922 783.352539,556.879517 780.769958,556.976013
                C777.152100,557.111328 773.525391,557.010193 769.070923,557.010193
                C769.070923,548.069153 769.070923,539.702454 769.070923,530.880432
                C761.295044,531.234619 754.387207,531.549316 746.793152,531.895203
                C746.793152,540.552856 746.793152,548.614624 746.793152,556.704529
                C743.490295,556.940002 740.900146,557.124634 738.228882,557.315063
                C738.228882,563.356934 738.228882,568.926392 738.228882,574.696594
                C741.165710,574.933350 743.751160,575.141724 746.934875,575.398315
                C746.934875,579.936768 746.934875,584.225037 746.934814,589.508179
            M566.572266,628.632324
                C566.445007,626.539673 566.317810,624.447083 566.161316,621.873962
                C563.023010,621.873962 560.363525,622.056213 557.739319,621.829773
                C554.127197,621.518066 550.882996,619.907593 550.811890,615.941650
                C550.571472,602.525879 550.720154,589.103088 550.720154,575.009094
                C554.461670,575.009094 558.087646,575.209167 561.669678,574.900024
                C562.914307,574.792603 565.020020,573.487183 565.075867,572.622070
                C565.401733,567.570190 565.235596,562.486511 565.235596,556.810059
                C559.821289,556.810059 555.259155,556.810059 550.064331,556.810059
                C550.064331,547.964661 550.064331,539.740173 550.064331,530.896301
                C542.356812,531.249268 535.343079,531.570496 527.821472,531.914978
                C527.821472,540.601318 527.821472,548.518738 527.821472,556.644897
                C524.586243,556.915833 521.875916,557.142761 519.285645,557.359619
                C519.285645,563.493835 519.285645,569.060486 519.285645,574.733643
                C522.285583,574.956909 524.867004,575.149109 527.934937,575.377441
                C527.934937,578.402832 527.883728,581.030823 527.943481,583.656372
                C528.250000,597.119080 528.186401,610.606873 529.053345,624.034180
                C529.611572,632.682068 535.284058,638.297546 543.824402,639.992126
                C547.697815,640.760742 551.757751,641.018982 555.710388,640.876831
                C566.576965,640.485901 566.572205,640.353638 566.572266,628.632324
            M552.584961,448.429199
                C553.469666,450.988586 550.385559,455.543335 555.586975,455.865875
                C562.505920,456.294922 569.471497,455.971802 576.555420,455.971802
                C576.555420,418.689972 576.555420,382.012939 576.555420,345.000977
                C570.298279,345.000977 564.459900,345.307922 558.670715,344.905853
                C553.861389,344.571808 552.450745,346.130219 552.481384,350.986816
                C552.684448,383.139587 552.585205,415.294250 552.584961,448.429199
            z"/>
            <path fill="#9D9D9D" opacity="1.000000" stroke="none"
                d="
            M260.311310,569.497803
                C262.980255,560.850586 264.540802,552.120117 268.399963,544.563599
                C275.610931,530.444031 290.542023,524.142090 307.394684,526.233398
                C323.439636,528.224548 332.798828,537.629211 336.966705,552.695679
                C338.372406,557.777161 339.054016,563.059021 340.254181,569.210999
                C332.383392,569.838135 325.238861,570.407410 317.929291,570.989807
                C317.169373,566.551270 316.742096,562.577942 315.779572,558.738770
                C313.721985,550.532166 308.967377,546.184021 302.385254,546.048279
                C295.963196,545.915771 290.184265,550.233826 288.246735,558.016602
                C284.040741,574.911743 283.859985,592.016052 287.884064,608.975952
                C289.724762,616.733521 294.851624,620.756775 301.384827,620.952637
                C307.983826,621.150330 312.654053,617.368225 315.356934,609.586243
                C315.847565,608.173584 316.570953,606.710876 316.558197,605.276794
                C316.502747,599.034790 320.084839,598.594299 325.019470,599.332336
                C328.957458,599.921387 333.028778,599.635315 336.957153,600.262268
                C338.104462,600.445435 339.919373,602.524231 339.813568,603.570984
                C338.142761,620.098694 328.831390,635.116638 312.734192,639.587036
                C295.303558,644.427612 278.046265,638.228577 268.994690,623.741638
                C261.180603,611.235413 259.567566,597.245239 259.631531,582.921204
                C259.650848,578.594788 260.027344,574.269958 260.311310,569.497803
            z"/>
            <path fill="#9D9D9D" opacity="1.000000" stroke="none"
                d="
            M460.911621,418.867798
                C467.922089,395.549133 474.942719,372.651184 481.646973,349.661011
                C482.758606,345.849060 484.451599,344.732086 488.224976,344.913910
                C494.525299,345.217499 500.850891,344.996796 507.790497,344.996796
                C518.324341,381.755890 528.830566,418.418732 539.585815,455.950409
                C531.351685,455.950409 523.934631,456.077789 516.533142,455.796570
                C515.557861,455.759491 514.187256,453.770386 513.812744,452.454041
                C512.311829,447.179474 511.049011,441.831818 509.868652,436.473663
                C509.314240,433.956970 508.153870,432.920227 505.457855,432.973206
                C497.470703,433.130157 489.476440,433.130615 481.489288,432.973633
                C478.599915,432.916870 477.371307,433.963806 476.809418,436.779480
                C475.736267,442.157257 474.465515,447.512726 472.888763,452.760864
                C472.496857,454.065063 470.665039,455.780975 469.422058,455.842987
                C463.131622,456.156738 456.817047,455.987366 449.749481,455.987366
                C453.556244,443.352692 457.186066,431.305206 460.911621,418.867798
            M490.894714,378.401703
                C488.144867,389.994751 485.395020,401.587830 482.552673,413.570740
                C490.085693,413.570740 496.898834,413.570740 504.280823,413.570740
                C500.678589,399.092377 497.213409,385.164764 493.748199,371.237122
                C493.374847,371.291351 493.001495,371.345551 492.628143,371.399780
                C492.097687,373.469879 491.567230,375.539978 490.894714,378.401703
            z"/>
            <path fill="#9E9E9E" opacity="1.000000" stroke="none"
                d="
            M379.479675,614.000244
                C379.479370,622.463623 379.479370,630.426941 379.479370,638.703125
                C371.617950,638.703125 364.387299,638.703125 356.784790,638.703125
                C356.784790,601.923706 356.784790,565.362732 356.784790,528.396240
                C364.193970,528.396240 371.413757,528.396240 379.513916,528.396240
                C379.513916,539.865417 379.513916,551.354492 379.513916,564.307190
                C387.600311,555.597351 396.301117,553.584839 406.035095,555.758850
                C413.241119,557.368286 417.796387,561.975891 419.049316,569.247620
                C419.864227,573.977234 420.194824,578.837219 420.241302,583.643677
                C420.403992,600.463135 420.358002,617.284668 420.361389,634.105408
                C420.361694,635.579041 420.143555,637.052673 420.012573,638.706787
                C412.494232,638.706787 405.254913,638.706787 397.613251,638.706787
                C397.504303,636.451050 397.335175,634.493469 397.326904,632.535217
                C397.257080,616.048157 397.328644,599.559570 397.118408,583.074402
                C397.019226,575.298767 395.147430,573.115540 389.679932,573.058960
                C383.467316,572.994568 380.123474,576.017334 379.846588,583.034668
                C379.446259,593.178894 379.576202,603.343994 379.479675,614.000244
            z"/>
            <path fill="#9E9E9E" opacity="1.000000" stroke="none"
                d="
            M643.410889,576.752075
                C646.922668,592.218445 647.082275,607.248047 641.976135,621.969604
                C637.510193,634.845764 628.693420,641.102173 616.280151,641.010803
                C607.820007,640.948547 601.675781,637.095337 597.593262,629.318665
                C595.462036,632.783203 594.243408,637.173035 591.495178,638.584534
                C588.479126,640.133484 584.053101,638.937256 579.832214,638.937256
                C579.832214,601.877258 579.832214,565.171326 579.832214,528.228516
                C587.148926,528.228516 594.111816,528.228516 601.778015,528.228516
                C601.778015,539.447876 601.778015,550.645935 601.778015,562.578796
                C603.160950,561.884521 603.760376,561.710693 604.199463,561.344604
                C616.384216,551.184204 631.173157,553.572388 639.378662,567.221130
                C641.070312,570.034790 642.000305,573.306396 643.410889,576.752075
            M602.061707,593.520020
                C602.391235,601.315796 602.472961,609.132935 603.145020,616.899109
                C603.536072,621.418152 606.078430,624.705627 611.139282,624.918579
                C616.112610,625.127869 618.997009,622.296509 619.991760,617.782349
                C622.893127,604.615784 622.869812,591.380920 619.950317,578.219666
                C619.012451,573.991699 616.498413,570.928711 611.657654,571.080078
                C606.794373,571.232178 603.842773,574.134277 603.088318,578.661987
                C602.329590,583.215454 602.371033,587.902283 602.061707,593.520020
            z"/>
            <path fill="#9D9D9D" opacity="1.000000" stroke="none"
                d="
            M445.534576,636.548645
                C432.326630,623.852905 436.544586,600.207031 453.452240,593.457275
                C460.591858,590.607056 468.549622,589.652649 476.224640,588.370117
                C479.457275,587.829895 480.589478,586.707214 480.198669,583.626221
                C480.010712,582.144165 480.105286,580.627686 479.945099,579.140503
                C479.504272,575.047424 478.212677,571.546997 473.365143,571.106689
                C468.598328,570.673706 465.336670,572.776184 463.752411,577.307556
                C463.159363,579.003723 462.761780,580.768311 462.147797,582.955017
                C455.125031,582.250549 448.248535,581.560730 440.948456,580.828430
                C441.784668,572.296936 445.212280,565.656067 452.004547,561.284302
                C464.091064,553.504944 477.093140,552.851807 490.207581,558.220276
                C499.491058,562.020447 502.919403,569.929565 502.997223,579.515076
                C503.108063,593.168274 503.147339,606.822144 503.200165,620.475830
                C503.223175,626.422729 503.204010,632.369812 503.204010,638.674500
                C497.033569,638.674500 490.456451,638.674500 483.377777,638.674500
                C482.843719,635.483948 482.309265,632.291077 481.617218,628.156738
                C477.152710,634.211548 472.450836,638.981934 465.349792,640.384766
                C458.331390,641.771240 451.781006,640.951721 445.534576,636.548645
            M479.322571,614.501038
                C479.663300,609.834290 480.004028,605.167542 480.385468,599.943298
                C476.919250,600.600037 474.620575,600.904480 472.393738,601.484680
                C467.682037,602.712219 463.738586,604.906250 462.327179,610.077637
                C460.447754,616.963684 462.552460,623.371643 467.186859,624.693481
                C472.171234,626.115295 476.707733,622.546021 479.322571,614.501038
            z"/>
            <path fill="#9D9D9D" opacity="1.000000" stroke="none"
                d="
            M723.412659,621.278687
                C717.427673,635.707520 707.116272,641.819397 690.682678,640.948303
                C676.328369,640.187439 666.735046,632.774780 662.715454,618.749146
                C658.726196,604.828918 658.723206,590.750244 662.814575,576.854126
                C667.134705,562.181152 677.562744,554.966553 693.576721,555.000427
                C709.358521,555.033813 719.717346,562.174927 723.994934,576.622559
                C728.359680,591.364746 728.066833,606.194702 723.412659,621.278687
            M701.500488,578.356750
                C699.889709,576.157104 698.715454,573.273071 696.573242,571.906494
                C692.636047,569.394897 687.284485,571.707458 686.036560,576.808716
                C682.597656,590.866394 682.933167,605.072815 685.849548,619.223022
                C685.980286,619.857239 686.303772,620.475464 686.640198,621.039917
                C689.794312,626.332642 697.115845,626.374207 700.095032,620.983826
                C701.110474,619.146606 701.956543,616.924316 701.969238,614.872375
                C702.042725,602.961548 701.844543,591.049011 701.500488,578.356750
            z"/>
            <path fill="#9D9D9D" opacity="1.000000" stroke="none"
                d="
            M746.934814,589.010742
                C746.934875,584.225037 746.934875,579.936768 746.934875,575.398315
                C743.751160,575.141724 741.165710,574.933350 738.228882,574.696594
                C738.228882,568.926392 738.228882,563.356934 738.228882,557.315063
                C740.900146,557.124634 743.490295,556.940002 746.793152,556.704529
                C746.793152,548.614624 746.793152,540.552856 746.793152,531.895203
                C754.387207,531.549316 761.295044,531.234619 769.070923,530.880432
                C769.070923,539.702454 769.070923,548.069153 769.070923,557.010193
                C773.525391,557.010193 777.152100,557.111328 780.769958,556.976013
                C783.352539,556.879517 784.484375,557.932922 784.307312,560.473328
                C784.295776,560.638794 784.321594,560.806641 784.316772,560.972900
                C784.191162,565.291443 785.544373,570.681030 783.449829,573.576111
                C781.885498,575.738464 775.868958,574.671936 771.837158,575.065125
                C771.196594,575.127625 770.567444,575.305969 769.197998,575.575439
                C769.197998,581.502319 769.187561,587.445923 769.200867,593.389526
                C769.214661,599.555603 769.125244,605.725525 769.309875,611.886841
                C769.545593,619.753357 771.772339,621.827698 779.659912,621.987366
                C781.308716,622.020752 782.958801,621.992249 785.483887,621.992249
                C785.483887,627.251892 785.641663,632.173767 785.352966,637.069397
                C785.294067,638.068420 783.583252,639.756104 782.591248,639.787842
                C775.657043,640.009399 768.556946,640.781738 761.810120,639.625854
                C753.931763,638.276123 748.687805,632.618958 748.090820,624.438110
                C747.243591,612.828491 747.277405,601.154602 746.934814,589.010742
            z"/>
            <path fill="#9D9D9D" opacity="1.000000" stroke="none"
                d="
            M566.572266,629.098022
                C566.572205,640.353638 566.576965,640.485901 555.710388,640.876831
                C551.757751,641.018982 547.697815,640.760742 543.824402,639.992126
                C535.284058,638.297546 529.611572,632.682068 529.053345,624.034180
                C528.186401,610.606873 528.250000,597.119080 527.943481,583.656372
                C527.883728,581.030823 527.934937,578.402832 527.934937,575.377441
                C524.867004,575.149109 522.285583,574.956909 519.285645,574.733643
                C519.285645,569.060486 519.285645,563.493835 519.285645,557.359619
                C521.875916,557.142761 524.586243,556.915833 527.821472,556.644897
                C527.821472,548.518738 527.821472,540.601318 527.821472,531.914978
                C535.343079,531.570496 542.356812,531.249268 550.064331,530.896301
                C550.064331,539.740173 550.064331,547.964661 550.064331,556.810059
                C555.259155,556.810059 559.821289,556.810059 565.235596,556.810059
                C565.235596,562.486511 565.401733,567.570190 565.075867,572.622070
                C565.020020,573.487183 562.914307,574.792603 561.669678,574.900024
                C558.087646,575.209167 554.461670,575.009094 550.720154,575.009094
                C550.720154,589.103088 550.571472,602.525879 550.811890,615.941650
                C550.882996,619.907593 554.127197,621.518066 557.739319,621.829773
                C560.363525,622.056213 563.023010,621.873962 566.161316,621.873962
                C566.317810,624.447083 566.445007,626.539673 566.572266,629.098022
            z"/>
            <path fill="#9C9C9C" opacity="1.000000" stroke="none"
                d="
            M552.584717,447.938751
                C552.585205,415.294250 552.684448,383.139587 552.481384,350.986816
                C552.450745,346.130219 553.861389,344.571808 558.670715,344.905853
                C564.459900,345.307922 570.298279,345.000977 576.555420,345.000977
                C576.555420,382.012939 576.555420,418.689972 576.555420,455.971802
                C569.471497,455.971802 562.505920,456.294922 555.586975,455.865875
                C550.385559,455.543335 553.469666,450.988586 552.584717,447.938751
            z"/>
            <path fill="#FCFCFC" opacity="1.000000" stroke="none"
                d="
            M490.965759,378.005890
                C491.567230,375.539978 492.097687,373.469879 492.628143,371.399780
                C493.001495,371.345551 493.374847,371.291351 493.748199,371.237122
                C497.213409,385.164764 500.678589,399.092377 504.280823,413.570740
                C496.898834,413.570740 490.085693,413.570740 482.552673,413.570740
                C485.395020,401.587830 488.144867,389.994751 490.965759,378.005890
            z"/>
            <path fill="#FDFDFD" opacity="1.000000" stroke="none"
                d="
            M602.061768,593.025330
                C602.371033,587.902283 602.329590,583.215454 603.088318,578.661987
                C603.842773,574.134277 606.794373,571.232178 611.657654,571.080078
                C616.498413,570.928711 619.012451,573.991699 619.950317,578.219666
                C622.869812,591.380920 622.893127,604.615784 619.991760,617.782349
                C618.997009,622.296509 616.112610,625.127869 611.139282,624.918579
                C606.078430,624.705627 603.536072,621.418152 603.145020,616.899109
                C602.472961,609.132935 602.391235,601.315796 602.061768,593.025330
            z"/>
            <path fill="#FDFDFD" opacity="1.000000" stroke="none"
                d="
            M479.221252,614.902832
                C476.707733,622.546021 472.171234,626.115295 467.186859,624.693481
                C462.552460,623.371643 460.447754,616.963684 462.327179,610.077637
                C463.738586,604.906250 467.682037,602.712219 472.393738,601.484680
                C474.620575,600.904480 476.919250,600.600037 480.385468,599.943298
                C480.004028,605.167542 479.663300,609.834290 479.221252,614.902832
            z"/>
            <path fill="#FEFEFE" opacity="1.000000" stroke="none"
            d="
            M701.619385,578.746948
            C701.844543,591.049011 702.042725,602.961548 701.969238,614.872375
            C701.956543,616.924316 701.110474,619.146606 700.095032,620.983826
            C697.115845,626.374207 689.794312,626.332642 686.640198,621.039917
            C686.303772,620.475464 685.980286,619.857239 685.849548,619.223022
            C682.933167,605.072815 682.597656,590.866394 686.036560,576.808716
            C687.284485,571.707458 692.636047,569.394897 696.573242,571.906494
            C698.715454,573.273071 699.889709,576.157104 701.619385,578.746948
            z"/>
            </svg>
        </div>
    `;
  }

  const chatOverlay = document.createElement('div');
  chatOverlay.className = 'saicf-chat-overlay hidden';

  const chatWindow = document.createElement('div');
  chatWindow.className = 'saicf-chat-window hidden';

  const logoHTML = logo
    ? `<img src="${logo}" alt="Chat Logo"
         style="height:24px;width:24px;border-radius:50%;object-fit:cover;"/>`
    : '';
  const headerHTML = `
    <div class="saicf-chat-header" style="background-color:${themeColor};">
      <div class="saicf-chat-header-title">
        <div class="saicf-logo-message-container">
          ${logoHTML}
          <span class="saicf-chat-title" style="color:${headerFontColor};">${widgetHeaderText}</span>
        </div>
        <button class="saicf-close-btn saicf-close-chat-widget-icon" style="color:${headerFontColor};">
          X
        </button>
      </div>
    </div>
  `;
  chatWindow.innerHTML = `
    ${headerHTML}
    <div class="saicf-chat-body"></div>
    <div class="saicf-chat-footer">
      <div class="saicf-powered-by">
        <span class="saicf-powered-by-text" onclick="window.open('http://ultimo-bots.com/', '_blank')">
          Powered by Ultimo Bots
        </span>
      </div>
      <div class="saicf-input-send-container">
        <input type="text" class="saicf-chat-input" placeholder="Type your message...">
        <button class="saicf-send-message" style="background-color:${themeColor};">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" style="width: 16px; height: 16px; fill: ${headerFontColor};">
            <path d="M214.6 41.4c-12.5-12.5-32.8-12.5-45.3 0L7 203.6c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L160 140.3V464c0 17.7 14.3 32 32 32s32-14.3 32-32V140.3l107.6 108.7c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L214.6 41.4z"/>
          </svg>
        </button>
      </div>
    </div>
  `;

  const popUpContainer = document.createElement('div');
  popUpContainer.className = 'saicf-pop-up-container hidden';

  const popUpCloseBtn = document.createElement('button');
  popUpCloseBtn.className = 'saicf-pop-up-close';
  popUpCloseBtn.textContent = 'X';
  popUpCloseBtn.style.backgroundColor = themeColor;
  popUpCloseBtn.style.color = headerFontColor;
  popUpCloseBtn.style.borderRadius = '50%';
  popUpCloseBtn.style.padding = '0px';
  popUpCloseBtn.style.width = '22px';
  popUpCloseBtn.style.height = '22px';
  popUpCloseBtn.style.display = 'flex';
  popUpCloseBtn.style.alignItems = 'center';
  popUpCloseBtn.style.justifyContent = 'center';
  popUpCloseBtn.style.fontSize = '14px';
  popUpCloseBtn.style.fontWeight = '600';
  popUpContainer.appendChild(popUpCloseBtn);

  welcomeMessages.forEach(msg => {
    const msgEl = document.createElement('div');
    msgEl.className = 'saicf-pop-up-message';
    msgEl.textContent = msg;
    popUpContainer.appendChild(msgEl);

    // âœ… Click opens chat exactly like the widget icon
    msgEl.addEventListener('click', () => {
      chatWindow.classList.remove('hidden');
      forceReflow(chatWindow);
      chatWindow.classList.add('show');
      chatOverlay.classList.remove('hidden');

      if (window.matchMedia('(max-width: 768px)').matches) {
        document.body.classList.add('no-scroll');
      }

      if (chatBody.childElementCount === 0) {
        welcomeMessages.forEach(msg => {
          appendMessage(msg, 'bot');
        });
      }

      widgetOpenedOnce = true;
      hidePopUp();
    });
  });

  widgetRoot.appendChild(chatWidgetIcon);
  widgetRoot.appendChild(chatOverlay);
  widgetRoot.appendChild(chatWindow);
  widgetRoot.appendChild(popUpContainer);

  if (horizontalAlignment === 'left') {
    chatWidgetIcon.classList.add('align-left');
    chatWindow.classList.add('align-left');
    popUpContainer.classList.add('align-left');
  }
  if (verticalAlignment === 'elevated') {
    chatWidgetIcon.classList.add('elevated');
    chatWindow.classList.add('elevated');
  }

  const dynamicStyleEl = document.createElement('style');
  dynamicStyleEl.textContent = `
    .saicf-chat-footer button:hover {
      background-color: ${hoverColor} !important;
    }
    .widget-user-message {
      background-color: ${themeColor} !important;
    }
    .saicf-loading-dots div {
      background-color: ${themeColor} !important;
    }
  `;
  shadowRoot.appendChild(dynamicStyleEl);

  const closeChatBtn   = chatWindow.querySelector('.saicf-close-btn');
  const chatBody       = chatWindow.querySelector('.saicf-chat-body');
  const chatInput      = chatWindow.querySelector('.saicf-chat-footer input');
  const sendMessageBtn = chatWindow.querySelector('.saicf-send-message');

  let sessionId = generateSessionId();
  let widgetOpenedOnce = false;

  chatWidgetIcon.addEventListener('click', () => {
    chatWindow.classList.remove('hidden');
    forceReflow(chatWindow);
    chatWindow.classList.add('show');
    chatOverlay.classList.remove('hidden');
    if (window.matchMedia('(max-width: 768px)').matches) {
      document.body.classList.add('no-scroll');
    }
    if (chatBody.childElementCount === 0) {
      welcomeMessages.forEach(msg => {
        appendMessage(msg, 'bot');
      });
    }
    widgetOpenedOnce = true;
    hidePopUp();
  });

  closeChatBtn.addEventListener('click', () => {
    closeChat();
  });

  sendMessageBtn.addEventListener('click', () => {
    sendMessage();
  });

  chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });

  popUpCloseBtn.addEventListener('click', e => {
    e.stopPropagation();
    hidePopUp();
    widgetOpenedOnce = true;
  });

  function showPopUpSequentially() {
    if (widgetOpenedOnce) return;
    popUpContainer.classList.remove('hidden');

    const msgs = popUpContainer.querySelectorAll('.saicf-pop-up-message');
    msgs.forEach((msg, i) => {
      setTimeout(() => {
        msg.classList.add('show');
        if (i === 0) {
          popUpCloseBtn.classList.add('show');
        }
      }, i * 1200);
    });
  }

  function hidePopUp() {
    popUpContainer.classList.add('hidden');
    popUpContainer.querySelectorAll('.saicf-pop-up-message')
                  .forEach(m => m.classList.remove('show'));
    popUpCloseBtn.classList.remove('show');
  }

  setTimeout(showPopUpSequentially, popUpDelaySeconds * 1000);

  function forceReflow(element) {
    void element.offsetHeight;
  }

  function closeChat() {
    chatWindow.classList.remove('show');
    chatOverlay.classList.add('hidden');
    if (window.matchMedia('(max-width: 768px)').matches) {
      document.body.classList.remove('no-scroll');
    }
    setTimeout(() => chatWindow.classList.add('hidden'), 300);
  }

  function generateSessionId() {
    const timestamp = new Date().getTime();
    const randomNum = Math.floor(Math.random() * 10000) + 1;
    return `${timestamp}-${randomNum}`;
  }

  async function sendMessage() {
    const message = chatInput.value.trim();
    if (!message) return;

    appendMessage(message, 'user');
    chatInput.value = '';
    setLoading(true);

    let currentBotMessage = '';
    const maxRetries = 3;
    let retryCount = 0;

    const attemptConnection = () => {
      return new Promise((resolve, reject) => {
        const url = `https://portal.ultimo-bots.com/api/chatbot_response?user_input=${encodeURIComponent(message)}&session_id=${sessionId}&bot_id=${botId}&language=english`;
        const eventSource = new EventSource(url);

        let isFirstMessage = true;
        let timeoutId;

        eventSource.onmessage = (event) => {
          const chunk = event.data;
          if (chunk !== 'end of response') {
            if (isFirstMessage) {
              setLoading(false);
              isFirstMessage = false;
              clearTimeout(timeoutId);
            }
            const parsedChunk = chunk.replace(/<newline>/g, '\n');
            currentBotMessage += parsedChunk;
            updateBotMessage(currentBotMessage);
            scrollToBottom();
          }
        };

        eventSource.onerror = (error) => {
          if (isFirstMessage) {
            reject(new Error('Failed to get response from server.'));
          }
          eventSource.close();
        };

        eventSource.addEventListener('end', () => {
          updateBotMessage(currentBotMessage);
          eventSource.close();
          setLoading(false);
          scrollToBottom();
          resolve();
        });

        timeoutId = setTimeout(() => {
          if (isFirstMessage) {
            eventSource.close();
            reject(new Error('No response received from server.'));
          }
        }, 8000);
      });
    };

    const retryConnection = async () => {
      while (retryCount < maxRetries) {
        try {
          await attemptConnection();
          return;
        } catch (error) {
          retryCount++;
          if (retryCount >= maxRetries) {
            setLoading(false);
            appendMessage(`Failed to get response after ${maxRetries} attempts.`, 'bot');
            throw error;
          }
        }
      }
    };

    try {
      await retryConnection();
    } catch (error) {
      setLoading(false);
    }
  }

  function updateBotMessage(text) {
    const lastMessage = chatBody.lastElementChild;
    if (lastMessage && lastMessage.classList.contains('widget-bot-message')) {
      if (typeof marked !== 'undefined') {
        lastMessage.innerHTML = marked.parse(text);
      } else {
        lastMessage.textContent = text;
      }
    } else {
      appendMessage(text, 'bot');
    }
  }

  function appendMessage(text, sender) {
    const messageElement = document.createElement('div');
    messageElement.className = `saicf-widget-message widget-${sender}-message`;
    if (typeof marked !== 'undefined') {
      messageElement.innerHTML = marked.parse(text);
    } else {
      messageElement.textContent = text;
    }
    chatBody.appendChild(messageElement);
    scrollToBottom();
  }

  function scrollToBottom() {
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  function setLoading(isLoading) {
    if (isLoading) {
      const loadingDots = document.createElement('div');
      loadingDots.className = 'saicf-loading-dots';
      loadingDots.innerHTML = '<div></div><div></div><div></div>';
      chatBody.appendChild(loadingDots);
      scrollToBottom();
    } else {
      const loadingDots = chatBody.querySelector('.saicf-loading-dots');
      if (loadingDots) {
        loadingDots.remove();
      }
    }
  }
}
